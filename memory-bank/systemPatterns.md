# System Patterns

Проект построен на основе **гексагональной архитектуры (Ports and Adapters)**, что обеспечивает слабую связанность между доменной логикой и инфраструктурными компонентами, такими как база данных или кэш. Этот подход дополняется элементами **доменно-ориентированного проектирования (DDD)**, с кодом, организованным вокруг бизнес-сущностей (Турнир, Игрок, Семья). Для работы с данными применяется паттерн **Repository**, который абстрагирует логику доступа к данным, и **CQRS-light**, разделяющий операции чтения и записи для оптимизации производительности.

На фронтенде используется модульная архитектура **Container/View/Hook**, разделяющая компоненты на логику, отображение и состояние. Применяется подход **React Server Components (RSC)** для рендеринга на сервере и уменьшения нагрузки на клиент, а также **Server Actions** для обработки форм. Для кэширования реализована многоуровневая стратегия с использованием Redis на сервере и React Query на клиенте, с абстракцией через **Adapter Pattern** для возможности переключения на in-memory кэш в среде разработки.

Для продакшен-окружения рекомендуется паритет (использование Redis также в разработке) и обеспечение высокой доступности через **Redis Sentinel**.

Безопасность обеспечивается через многоуровневую защиту (**Defense in Depth**), ограничение частоты запросов (**Rate Limiting**) и защиту от CSRF. Для безопасной передачи чувствительных данных в продакшене используется паттерн **Docker Secrets**. Интеграция между сервисами осуществляется через асинхронные паттерны, такие как **Publisher/Subscriber** с использованием Redis Pub/Sub и фоновые задачи на **BullMQ**, которые управляются через механизм **Repeatable Jobs**.

## Паттерны работы с данными

### [АКТИВНЫЙ] Витрина данных (Data Showcase)
- **Сущности**: `PlayerStats`, `FamilyStats`
- **Описание**: Для часто запрашиваемой, но редко изменяемой агрегированной статистики (например, общая статистика игрока за всю карьеру) создается отдельная "витринная" коллекция. Данные в ней обновляются инкрементально после завершения ключевых событий (например, после завершения карты).
- **Преимущества**: Максимально быстрые операции чтения, так как все данные уже посчитаны и лежат в одном документе. Снижение нагрузки на основную базу данных при частых запросах.
- **Недостатки**: Требует дополнительного места для хранения и усложняет логику записи, так как нужно обновлять несколько коллекций.

### [АКТИВНЫЙ] Агрегация на лету с кэшированием (On-the-fly Aggregation with Caching)
- **Сущности**: Статистика турнира (`Tournament Stats`)
- **Описание**: Для статистики, которая нужна в рамках ограниченного контекста (например, лидерборд игроков внутри одного турнира), используется прямой агрегирующий запрос к "сырым" логам (`PlayerMapParticipation`) с помощью MongoDB Aggregation Pipeline. Результат этого сложного запроса агрессивно кэшируется в Redis.
- **Преимущества**: Не требует создания дополнительных "витринных" таблиц. Данные всегда на 100% консистентны с исходными. Гибкость в построении любых отчетов.
- **Недостатки**: Первый запрос (когда кэш пуст) может быть ресурсоемким. Требует хорошо настроенного кэширования.
- **Реализация**: `TournamentRepository.getTournamentStats`.

### [АРХИВ] Лог + Витрина (Log + Showcase) - Устарел
- **Описание**: Исходный паттерн, который предполагал наличие "витрин" для всех уровней статистики. Был заменен на более гибкий гибридный подход. 