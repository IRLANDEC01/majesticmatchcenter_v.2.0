# Progress Tracker

## Завершённые задачи (Done)

### Этап 0: Архитектура и настройка
- **[✓]** Проанализирована и обновлена архитектурная документация (`/architecture`).
- **[✓]** Настроена базовая структура проекта: Next.js, Docker, Jest, `migrate-mongo`.
- **[✓]** Реализованы базовые утилиты: `getCacheAdapter` (Redis), `Winston` (логгер).
- **[✓]** Созданы все ключевые Mongoose модели.

### Этап 1: Базовый CRUD и рефакторинг API
- **[✓]** Реализованы CRUD-операции для всех основных сущностей (Tournaments, Maps, Players, Families, Templates).
- **[✓]** Внедрена централизованная система обработки ошибок (`handleApiError` и кастомные ошибки).
- **[✓]** Проведен рефакторинг механизма "мягкого удаления" через поле `archivedAt`.
- **[✓]** Реализована логика автоматической смены статуса `planned`/`active` для карт и турниров.

### Этап 2: Рефакторинг генерации Slug и стабилизация
- **[✓]** **Ключевая логика `slug`**: Реализована новая, надежная система генерации `slug` для турниров и карт, основанная на атомарных счетчиках и гарантирующая уникальность.
- **[✓]** **Рефакторинг сервисов**: Проведен полный рефакторинг `TournamentService`, `MapService`, `MapTemplateService` с внедрением зависимостей (DI) и приведением к единому стилю.
- **[✓]** **Стабилизация тестов**: Исправлены многочисленные регрессионные ошибки, все 87 интеграционных тестов успешно проходят (`npm test -- --runInBand`). Кодовая база стабильна.

---

## Предстоящие задачи (Next Steps)

### Этап 3: Завершение Карты (Map Completion) — **В РАБОТЕ**
*Цель: Реализовать основной бизнес-процесс завершения игровой сессии, включая обновление всей связанной статистики и рейтингов.*

#### 3.1. Фундамент: Сервисы Рейтинга и Статистики
- **Статус:** **[ЗАВЕРШЕНО]**
- **[✓]** **RatingService:** Создан сервис и репозитории (`player-rating-history-repo`, `family-rating-history-repo`) для управления историей и начислением рейтинга.
- **[✓]** **StatisticsService:** Создан сервис и репозитории (`player-stats-repo`, `player-map-participation-repo`) для парсинга и сохранения статистики матчей.
- **[✓]** **Интеграция:** Новые сервисы интегрированы в `MapService` через Dependency Injection.
- **[✓]** **Стабилизация:** Все тесты (88) успешно пройдены после добавления новой логики и исправления всех ошибок.

#### 3.2. API и Логика Завершения
- [ ] **API-Маршрут:** Создать `POST /api/admin/maps/[id]/complete`.
- [ ] **Метод сервиса:** Реализовать `completeMap(mapId, data)` в `MapService`.
- [ ] **Контракт `data`:** Объект `data` должен содержать:
  - `winnerId`: ID победившей семьи/команды (обязательно).
  - `mvpId`: ID лучшего игрока (обязательно).
  - `ratingChanges`: `{ [familyId]: change }` (опционально).
  - `statistics`: Содержимое JSON-файла статистики (опционально).
- [ ] **Регрессионное тестирование**: Автоматизированные тесты для предотвращения регрессий
- [ ] **Снапшот-тестирование**: Для отслеживания изменений в UI компонентах

## Этап 2: Рефакторинг - Мягкое удаление (`archivedAt`)

- **Цель:** Заменить разрозненные статусы на единое поле `archivedAt` для унифицированного механизма мягкого удаления.
- **Статус:** **[ЗАВЕРШЕНО]**

- **Выполнено:**
  - **[✓]** **Player:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Family:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Tournament:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Map:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **TournamentTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **MapTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** Все связанные сущности проверены и обновлены.

## Этап 4: Жизненный цикл Турнира

- **[✓]** Реализовать логику завершения турнира.
- **[✓]** Реализовать начисление призов.

## Этап 5: API

- **[✓]** Реализован эндпоинт `POST /api/admin/tournaments` для создания турниров.
- **[✓]** Реализованы эндпоинты `GET`, `PUT`, `DELETE` для `/api/admin/tournaments/[id]`.
- **[✓]** Реализовать эндпоинт `GET /api/public/tournaments/[slug]/stats` для получения статистики турнира.

## В процессе (In Progress)

### Архитектура и Рефакторинг
- [ ] **Рефакторинг эндпоинтов архивации `Tournaments`**: Перевести эндпоинт на `PATCH /.../[id]/archive`.

### Функционал
- [ ] **Реализовать создание сущности "Новости" (News)**: Модель, репозиторий, сервис и API-маршруты.

## Готово (Done)
*Этот раздел объединен с основными этапами для устранения дублирования.* 