# Progress Tracker

## Завершённые задачи (Done)

### Этап 0: Архитектура и настройка
- **[✓]** Проанализирована и обновлена архитектурная документация (`/architecture`).
- **[✓]** Настроена базовая структура проекта: Next.js, Docker, Jest, `migrate-mongo`.
- **[✓]** Реализованы базовые утилиты: `getCacheAdapter` (Redis), `Winston` (логгер).
- **[✓]** Созданы все ключевые Mongoose модели.

### Этап 1: Базовый CRUD и рефакторинг API
- **[✓]** Реализованы CRUD-операции для всех основных сущностей (Tournaments, Maps, Players, Families, Templates).
- **[✓]** Внедрена централизованная система обработки ошибок (`handleApiError` и кастомные ошибки).
- **[✓]** Проведен рефакторинг механизма "мягкого удаления" через поле `archivedAt`.
- **[✓]** Реализована логика автоматической смены статуса `planned`/`active` для карт и турниров.

### Этап 2: Рефакторинг генерации Slug и стабилизация
- **[✓]** **Ключевая логика `slug`**: Реализована новая, надежная система генерации `slug` для турниров и карт, основанная на атомарных счетчиках и гарантирующая уникальность.
- **[✓]** **Рефакторинг сервисов**: Проведен полный рефакторинг `TournamentService`, `MapService`, `MapTemplateService` с внедрением зависимостей (DI) и приведением к единому стилю.
- **[✓]** **Стабилизация тестов**: Исправлены многочисленные регрессионные ошибки, все 87 интеграционных тестов успешно проходят (`npm test -- --runInBand`). Кодовая база стабильна.

---

## Предстоящие задачи (Next Steps)

### Этап 3: Завершение Карты (Map Completion) — **ПЕРЕЗАПУСК**
*Цель: Реализовать основной бизнес-процесс завершения карты, используя пошаговый и тестируемый подход для обеспечения стабильности.*

#### 3.1. Укрепление фундамента (Foundation)
- **Статус:** **[В РАБОТЕ]**
- [ ] **Тестирование DI-контейнера:** Создать модульный тест `di-container.test.js` для проверки корректной инициализации всех сервисов и их зависимостей.
- [ ] **Аудит тестов:** Провести ревизию существующих тестов на предмет соответствия стратегии (API-тесты не должны мокать сервисы).

#### 3.2. Разработка через тестирование (TDD) для MapService
- **Статус:** **[ОЖИДАНИЕ]**
- [ ] **Модульный тест для MapService:** Создать `map-service.test.js` для изолированного тестирования сложной логики.
- [ ] **Написать тест-кейсы для `completeMap`:**
  - [ ] Тест: `completeMap` корректно обновляет статус, `winner` и `mvp` в модели `Map`.
  - [ ] Тест: `completeMap` правильно находит ID участника-победителя (а не семьи).
  - [ ] Тест: `completeMap` вызывает `ratingService` с правильными данными (используя мок).
  - [ ] Тест: `completeMap` вызывает `statisticsService` с правильными данными (используя мок).
- [ ] **Реализация `completeMap`:** Написать код функции, чтобы все модульные тесты прошли.

#### 3.3. Финальная интеграция в API
- **Статус:** **[ОЖИДАНИЕ]**
- [ ] **API-Маршрут:** Создать `POST /api/admin/maps/[id]/complete/route.js`.
- [ ] **Интеграционный тест:** Написать простой интеграционный тест, который проверяет только конечный результат: запрос => ответ `200 OK` => статус карты в БД изменен на `completed`.

## Этап 2: Рефакторинг - Мягкое удаление (`archivedAt`)

- **Цель:** Заменить разрозненные статусы на единое поле `archivedAt` для унифицированного механизма мягкого удаления.
- **Статус:** **[ЗАВЕРШЕНО]**

- **Выполнено:**
  - **[✓]** **Player:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Family:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Tournament:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Map:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **TournamentTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **MapTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** Все связанные сущности проверены и обновлены.

## Этап 4: Жизненный цикл Турнира

- **[✓]** Реализовать логику завершения турнира.
- **[✓]** Реализовать начисление призов.

## Этап 5: API

- **[✓]** Реализован эндпоинт `POST /api/admin/tournaments` для создания турниров.
- **[✓]** Реализованы эндпоинты `GET`, `PUT`, `DELETE` для `/api/admin/tournaments/[id]`.
- **[✓]** Реализовать эндпоинт `GET /api/public/tournaments/[slug]/stats` для получения статистики турнира.

## В процессе (In Progress)

### Архитектура и Рефакторинг
- [ ] **Рефакторинг эндпоинтов архивации `Tournaments`**: Перевести эндпоинт на `PATCH /.../[id]/archive`.

### Функционал
- [ ] **Реализовать создание сущности "Новости" (News)**: Модель, репозиторий, сервис и API-маршруты.

## Готово (Done)
*Этот раздел объединен с основными этапами для устранения дублирования.* 