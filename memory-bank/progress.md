# Progress Tracker

## Завершённые задачи (Done)

### Этап 0: Архитектура и настройка
- **[✓]** Проанализирована и обновлена архитектурная документация (`/architecture`).
- **[✓]** Настроена базовая структура проекта: Next.js, Docker, Jest, `migrate-mongo`.
- **[✓]** Реализованы базовые утилиты: `getCacheAdapter` (Redis), `Winston` (логгер).
- **[✓]** Созданы все ключевые Mongoose модели.

### Этап 1: Базовый CRUD и рефакторинг API
- **[✓]** Реализованы CRUD-операции для всех основных сущностей (Tournaments, Maps, Players, Families, Templates).
- **[✓]** Внедрена централизованная система обработки ошибок (`handleApiError` и кастомные ошибки).
- **[✓]** Проведен рефакторинг механизма "мягкого удаления" через поле `archivedAt`.
- **[✓]** Реализована логика автоматической смены статуса `planned`/`active` для карт и турниров.

### Этап 2: Рефакторинг генерации Slug и стабилизация
- **[✓]** **Ключевая логика `slug`**: Реализована новая, надежная система генерации `slug` для турниров и карт, основанная на атомарных счетчиках и гарантирующая уникальность.
- **[✓]** **Рефакторинг сервисов**: Проведен полный рефакторинг `TournamentService`, `MapService`, `MapTemplateService` с внедрением зависимостей (DI) и приведением к единому стилю.
- **[✓]** **Стабилизация тестов**: Исправлены многочисленные регрессионные ошибки, все 87 интеграционных тестов успешно проходят (`npm test -- --runInBand`). Кодовая база стабильна.

---

## Предстоящие задачи (Next Steps)

### Этап 3: Завершение Карты (Map Completion) — **В РАБОТЕ**
*Цель: Реализовать основной бизнес-процесс завершения игровой сессии, включая обновление всей связанной статистики и рейтингов.*

#### 3.1. API и Сервис
- [ ] **API-Маршрут:** Создать `POST /api/admin/maps/[id]/complete`.
- [ ] **Метод сервиса:** Реализовать `completeMap(mapId, data)` в `MapService`.
- [ ] **Контракт `data`:** Объект `data` должен содержать:
  - `winnerId`: ID победившей семьи/команды (обязательно).
  - `mvpId`: ID лучшего игрока (обязательно).
  - `ratingChanges`: `{ [familyId]: change }` (опционально).
  - `statistics`: Содержимое JSON-файла статистики (опционально).

#### 3.2. Валидация
- [ ] **Zod-схема:** Создать схему для валидации входных данных `data`.
- [ ] **Проверки в сервисе:**
  - [ ] Карта существует и находится в статусе `active`.
  - [ ] `winnerId` и `mvpId` переданы и валидны.

#### 3.3. Логика `completeMap`
- [ ] **Обновление карты:** Изменить статус на `completed`, сохранить `winner` и `mvp`.
- [ ] **Интеграция с `RatingService`:**
  - [ ] Если переданы `ratingChanges`, вызвать `ratingService.updateFamilyRatings(...)`.
  - [ ] Если загружен `statistics`, внутри `StatisticsService` вызвать `ratingService.updatePlayerRatings(...)` для начисления рейтинга за `kills`.
- [ ] **Интеграция со `StatisticsService`:**
  - [ ] Если загружен `statistics`, вызвать `statisticsService.parseAndApplyMapStats(...)` для обновления статистики игроков.
- [ ] **Интеграция с `AchievementService`:**
  - [ ] Вызвать `achievementService.createMapCompletionAwards(...)` для создания записей о MVP и других наградах.

#### 3.4. Тестирование
- [ ] **Интеграционный тест:** Создать `maps/[id]/complete/route.test.js`.
- [ ] **Сценарии теста:**
  - [ ] Успешное завершение с минимальными данными (`winner`, `mvp`).
  - [ ] Успешное завершение с начислением рейтинга семьям.
  - [ ] Успешное завершение с загрузкой полной статистики (игроки, рейтинг, достижения).
  - [ ] Ошибки: попытка завершить неактивную или уже завершенную карту.

### Этап 4: Откат Завершения Карты (Rollback)
- [ ] **API-Маршрут:** Создать `POST /api/admin/maps/[id]/rollback`.
- [ ] **Метод сервиса:** Реализовать `rollbackMapCompletion(mapId)` в `MapService`.
- [ ] **Логика `rollbackMapCompletion`:**
  - [ ] Вызвать парные `rollback` методы в `RatingService`, `StatisticsService`, `AchievementService`.
  - [ ] Вернуть статус карты в `active`, очистить поля `winner`, `mvp` и т.д.
- [ ] **Тестирование:** Написать интеграционный тест для сценария отката.

### Этап 5: Жизненный цикл Турнира и Новости
- [ ] **Завершение турнира:** Реализовать логику завершения турнира (выбор победителя, начисление призов).
- [ ] **Новости:** Реализовать CRUD для сущности "Новости" (News).

### Бэклог (Backlog)
- [ ] **Рефакторинг эндпоинтов архивации `Tournaments`**: Перевести эндпоинт на `PATCH /.../[id]/archive`.
- [ ] **Публичное API:** Реализовать эндпоинт `GET /api/public/tournaments/[slug]/stats`.

## Этап 0: Планирование и архитектура

- **[✓]** Проанализирована первоначальная архитектурная документация.
- **[✓]** Выявлены потенциальные проблемы и предложены улучшения.
- **[✓]** Проведена реструктуризация и обновление документации в `architecture/`.
- **[✓]** `Memory Bank` создан и синхронизирован с финальной архитектурой.

## Этап 1: Инициализация и базовые модели

- **[✓]** Создана базовая структура каталогов проекта.
- **[✓]** Инициализировано Next.js приложение и настроены базовые конфигурации.
- **[✓]** Настроен Docker Compose для локальной разработки.
- **[✓]** Настроен `migrate-mongo`.
- **[✓]** Реализована базовая абстракция для кэша (`getCacheAdapter`) с Redis.
- **[✓]** Реализован базовый логгер (Winston).
- **[✓]** Созданы Mongoose модели для всех ключевых сущностей (Tournament, Map, Player, Family и их сателлиты).
- **[✓]** Настроена тестовая среда Jest для работы с ESM-модулями.
- **[✓]** Реализована логика генерации `slug` для турниров и карт в доменных сервисах (`TournamentService`, `MapService`).

## Этап 2: Рефакторинг - Мягкое удаление (`archivedAt`)

- **Цель:** Заменить разрозненные статусы на единое поле `archivedAt` для унифицированного механизма мягкого удаления.
- **Статус:** **[ЗАВЕРШЕНО]**

- **Выполнено:**
  - **[✓]** **Player:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Family:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Tournament:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Map:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **TournamentTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **MapTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** Все связанные сущности проверены и обновлены.

## Этап 3: Завершение Карты и Управление Статистикой

- **[✓]** Реализованы эндпоинты `GET`, `PUT` для `/api/admin/tournaments/[id]`.
- **[✓]** Реализованы эндпоинты `GET`, `POST` для `/api/admin/maps`.
- **[✓]** Реализованы эндпоинты `GET`, `PUT`, `PATCH` для `/api/admin/maps/[id]`.
- **[✓]** Реализована логика автоматической смены статуса `planned`/`active` для карт.

- **[✓]** Реализован метод для агрегации статистики турнира (`Aggregation Pipeline`) в `TournamentRepository`.
- **[✓]** Созданы API-маршруты (Route Handlers) для управления турнирами (CRUD).
- **[✓]** Реализовать логику загрузки и парсинга статистики из JSON-файла на странице карты.
- **[✓]** Реализовать процесс завершения карты с обновлением статистики игроков и семей.

## Этап 4: Жизненный цикл Турнира

- **[✓]** Реализовать логику завершения турнира.
- **[✓]** Реализовать начисление призов.

## Этап 5: API

- **[✓]** Реализован эндпоинт `POST /api/admin/tournaments` для создания турниров.
- **[✓]** Реализованы эндпоинты `GET`, `PUT`, `DELETE` для `/api/admin/tournaments/[id]`.
- **[✓]** Реализовать эндпоинт `GET /api/public/tournaments/[slug]/stats` для получения статистики турнира.

## В процессе (In Progress)

### Архитектура и Рефакторинг
- [ ] **Рефакторинг эндпоинтов архивации `Tournaments`**: Перевести эндпоинт на `PATCH /.../[id]/archive`.

### Функционал
- [ ] **Реализовать создание сущности "Новости" (News)**: Модель, репозиторий, сервис и API-маршруты.

## Готово (Done)
*Этот раздел объединен с основными этапами для устранения дублирования.* 