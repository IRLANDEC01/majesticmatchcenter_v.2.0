# Журнал Прогресса

## Текущий этап: Завершение рефакторинга ядра и подготовка к UI

### Выполнено (Done)

- **✅ [Этап 1-2] Настройка и базовые модели**: Полностью завершены.
- **✅ [Этап 3] Стабилизация и рефакторинг API**:
  - Полностью переписаны тесты для `Families` и `Players` с использованием паттерна "Самодостаточных тестов". Зависимость от `populateDb` устранена.
  - Внедрена централизованная система валидации на базе Zod для `Families` и `Players`.
  - API-маршруты для `Families` и `Players` полностью отрефакторены и используют единый обработчик ошибок.
- **✅ [Этап 4-5] Бизнес-логика (Призовой фонд)**:
  - Проведен полный рефакторинг системы подсчета очков и призовых.
  - Жестко закодированный `scoringType` заменен на гибкую, управляемую данными систему "уровней призов" (`prizeTiers`) и результатов (`outcomes`).
  - Это делает старые планы по `MANUAL_SELECTION` и другим типам устаревшими, так как новая система может покрыть любые сценарии.

### В процессе (In Progress)

- **Рефакторинг оставшихся сущностей**: Применение новых паттернов тестирования и валидации к `Maps`, `Tournaments` и их шаблонам.

### Планы (Next Up)

**Блок 1: Фундамент UI для управления Семьями и Игроками**
- [ ] Создать страницу со списком Семей и формой для их создания (с Zod-валидацией).
- [ ] Создать страницу со списком Игроков и формой для их создания (с Zod-валидацией).
- [ ] Реализовать детальную страницу Семьи (`/admin/families/[id]`), отображающую состав.
- [ ] Добавить на страницу семьи функционал для смены владельца и добавления/удаления игроков.

**Блок 2: Укрепление бэкенда**
- [ ] Провести полный рефакторинг API для `Tournament Templates` (тесты, Zod-схемы, обработка ошибок).
- [ ] Провести полный рефакторинг API для `Map Templates`.

**Блок 3: Реализация жизненного цикла Турнира**
- [ ] Создать UI для создания Турнира из шаблона.
- [ ] Реализовать UI для завершения Турнира с вводом результатов (`outcomes`).
- [ ] Реализовать логику и UI для отката (rollback) ошибочно завершенных событий.

## Завершённые задачи (Done)

### Этап 0: Архитектура и настройка
- **[✓]** Проанализирована и обновлена архитектурная документация (`/architecture`).
- **[✓]** Настроена базовая структура проекта: Next.js, Docker, Jest, `migrate-mongo`.
- **[✓]** Реализованы базовые утилиты: `getCacheAdapter` (Redis), `Winston` (логгер).
- **[✓]** Созданы все ключевые Mongoose модели.

### Этап 1: Базовый CRUD и рефакторинг API
- **[✓]** Реализованы CRUD-операции для всех основных сущностей (Tournaments, Maps, Players, Families, Templates).
- **[✓]** Внедрена централизованная система обработки ошибок (`handleApiError` и кастомные ошибки).
- **[✓]** Проведен рефакторинг механизма "мягкого удаления" через поле `archivedAt`.
- **[✓]** Реализована логика автоматической смены статуса `planned`/`active` для карт и турниров.

### Этап 2: Стабилизация и ключевые фичи
- **[✓]** **Генерация Slug**: Реализована новая, надежная система генерации `slug` для турниров и карт.
- **[✓]** **Глобальный рефакторинг тестов**: Все интеграционные тесты переведены на новый стандарт с `test-helpers.js`, моки сервисов убраны.
- **[✓]** **Реализовано "Завершение Карты"**: Полностью разработан и протестирован бизнес-процесс завершения карты.
- **[✓]** **Стабилизация кодовой базы**: Все 93 интеграционных теста успешно проходят. Кодовая база стабильна.
- **[✓]** **Исправление предупреждений Mongoose:** Устранены предупреждения `Duplicate schema index` в моделях `Map` и `Tournament`.
- **[✓]** **Обновлена документация**: `10-testing-strategy.md` дополнена новыми анти-паттернами (особенно про Zod).

---

## Предстоящие задачи (Next Steps)

### **Этап 3: Архитектурный рефакторинг — Outcome-Driven Model**
- **Статус:** **[В ПРОЦЕССЕ]**
- **Цель:** Перейти на унифицированную модель обработки результатов турниров.
- [ ] **Документация:** `architecture/05c-business-logic-outcome-model.md` создана.
- [ ] **Реализация:**
    - [ ] Добавить константы `RESULT_TIERS`.
    - [ ] Обновить схемы `Tournament` и `FamilyTournamentParticipation`.
    - [ ] Переписать `tournament-service`.
    - [ ] Адаптировать все тесты.

### Этап 4: Укрепление фундамента (Foundation)
- **Статус:** **[ОЖИДАНИЕ]**
- [ ] **Аудит тестов:** Провести финальную ревизию существующих тестов на предмет соответствия стратегии.
- [ ] **Аудит сервисов:** Проверить, что все сервисы используют DI и получают зависимости в конструкторе.

### Этап 5: Функционал
- **Статус:** **[ОЖИДАНИЕ]**
- [ ] **Реализовать логику Завершения Турнира**:
    - **[✓]** Завершение турнира типа `LEADERBOARD`.
    - **[✓]** Начисление призов семьям и игрокам (`FamilyEarning`, `PlayerEarning`).
    - **[✓]** Обновление записи об участии в турнире (`FamilyTournamentParticipation`).
    - [ ] Реализовать завершение турнира типа `MANUAL_SELECTION`.
    - [ ] Реализовать расчет и присвоение MVP (Most Valuable Player) турнира.
    - [ ] Интегрировать с системой достижений (ачивки за победу, участие и т.д.).
- [ ] **Реализовать создание сущности "Новости" (News)**: Модель, репозиторий, сервис и API-маршруты.

## Этап 2: Рефакторинг - Мягкое удаление (`archivedAt`)

- **Цель:** Заменить разрозненные статусы на единое поле `archivedAt` для унифицированного механизма мягкого удаления.
- **Статус:** **[ЗАВЕРШЕНО]**

- **Выполнено:**
  - **[✓]** **Player:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Family:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Tournament:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **Map:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **TournamentTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** **MapTemplate:** Модель, репозиторий, сервис и API-маршруты.
  - **[✓]** Все связанные сущности проверены и обновлены.

## Этап 4: Жизненный цикл Турнира

- **[✓]** Реализована логика завершения турнира по лидерборду.
- **[✓]** Реализовано начисление призов.
- **[ ]** Реализовать ручное завершение турнира.
- **[ ]** Реализовать расчет MVP.

## Этап 5: API

- **[✓]** Реализован эндпоинт `POST /api/admin/tournaments` для создания турниров.
- **[✓]** Реализованы эндпоинты `GET`, `PUT`, `DELETE` для `/api/admin/tournaments/[id]`.
- **[✓]** Реализован эндпоинт `PATCH /api/admin/tournaments/[id]/complete` для завершения турнира типа `LEADERBOARD`.
- **[✓]** Реализован эндпоинт `GET /api/public/tournaments/[slug]/stats` для получения статистики турнира.

## В процессе (In Progress)

### Архитектура и Рефакторинг
- **Статус:** **[ОЖИДАНИЕ]**
- [ ] **Аудит тестов:** Провести финальную ревизию существующих тестов на предмет соответствия стратегии.
- [ ] **Аудит сервисов:** Проверить, что все сервисы используют DI и получают зависимости в конструкторе.

### Функционал
- **Статус:** **[В ПРОЦЕССЕ]**
- [ ] **Реализовать создание сущности "Новости" (News)**: Модель, репозиторий, сервис и API-маршруты.
- [ ] **Реализовать логику Завершения Турнира**: 
    - **[✓]** Завершение турнира типа `LEADERBOARD`.
    - [ ] Реализовать `MANUAL_SELECTION` и MVP.
    - [ ] Интегрировать с системой достижений.

## Готово (Done)
*Этот раздел объединен с основными этапами для устранения дублирования.*

- **[✓]** **Стабилизация кодовой базы**: Все 93 интеграционных теста успешно проходят. Кодовая база стабильна.
- **[✓]** **Исправление предупреждений Mongoose:** Устранены предупреждения `Duplicate schema index` в моделях `Map` и `Tournament`. 
- **[✓]** **Реализовано Завершение Турнира (LEADERBOARD)**: Полностью разработан и протестирован бизнес-процесс завершения турнира по лидерборду.
- **[✓]** **Спроектирован паттерн "Prize Tiers"**: Разработана и задокументирована гибкая система распределения призового фонда.

# Progress Log

## Текущий этап: Стабилизация и рефакторинг ядра (Core Refactoring)

### Выполнено (Done)
- **Полный рефакторинг тестов для сущностей `Families` и `Players`**:
  - Внедрен паттерн "Самодостаточных тестов" (Self-Contained Tests).
  - Устранены зависимости от хрупкого хелпера `populateDb`.
  - Тесты стали независимыми, надежными и прозрачными.
- **Внедрена централизованная система валидации на базе Zod**:
  - Создана единая структура для схем валидации в `src/lib/api/schemas/`.
  - API-маршруты `Families` и `Players` переведены на использование централизованных схем и единого обработчика ошибок `handleApiError`.
- **Стабилизирована тестовая среда**: Решены проблемы с запуском тестов в Jest и обработкой асинхронных операций.

### В процессе (In Progress)
- **Рефакторинг оставшихся сущностей**: Применение новых паттернов тестирования и валидации к `Maps`, `Tournaments` и их шаблонам.

### Планы (Next Up)
- Завершение рефакторинга бэкенда.
- Начало работ по UI для Админ-панели. 