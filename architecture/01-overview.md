# Архитектура MajesticMatchCenter: Обзор

## 1. Архитектурный стиль

MajesticMatchCenter использует **гексагональную архитектуру** (Ports and Adapters) с элементами **доменно-ориентированного проектирования (DDD)** и организацией кода по **Feature-Sliced Design (FSD)**. Это обеспечивает:

- Четкое разделение бизнес-логики от инфраструктуры
- Возможность замены внешних систем без изменения ядра приложения
- Улучшенную тестируемость через абстракции
- Высокую переиспользуемость и предсказуемую структуру кода

## 2. Ключевые архитектурные слои

### 2.1 Фронтенд (Feature-Sliced Design)
```
src/
├── app/           # Маршрутизация (Next.js App Router)
├── features/      # Бизнес-функциональности
├── entities/      # Бизнес-сущности  
└── shared/        # Переиспользуемые ресурсы
```

### 2.2 Бэкенд (Слоистая архитектура)
1. **API слой** (`/api/`)
   - Route Handlers (REST API)
   - Server Actions для форм
   - Валидация через Zod схемы

2. **Доменный слой** (`/lib/domain/`)
   - Сервисы с бизнес-логикой
   - Модели предметной области
   - Репозитории для доступа к данным

3. **Инфраструктурный слой**
   - MongoDB для хранения данных
   - Redis для кэширования и real-time коммуникации
   - Meilisearch для полнотекстового поиска
   - S3-совместимое хранилище для файлов

## 3. Технологический стек

### 3.1 Frontend

- **Next.js 15** - фреймворк для React с серверными компонентами
- **React 19** - библиотека для создания UI с новыми хуками (useActionState, useFormStatus)
- **TypeScript** - типизированный JavaScript для повышения надежности
- **TailwindCSS** - утилитарный CSS фреймворк
- **shadcn/ui** - компонентная библиотека
- **React Hook Form** - управление формами
- **Zod** - валидация данных
- **SWR** - кэширование и получение данных на клиенте

### 3.2 Backend

- **Next.js API Routes** - серверный API
- **TypeScript** - строгая типизация для backend логики
- **Mongoose 8** - ODM для MongoDB
- **Redis Node.js Client** - работа с Redis
- **Meilisearch** - полнотекстовый поиск
- **BullMQ** - очереди задач для фоновой обработки
- **Winston** - логирование

### 3.3 Инфраструктура

- **MongoDB 7** - основная база данных
- **Redis 7** - кэширование, pub/sub, очереди задач
- **Meilisearch** - поисковая система
- **Docker** - контейнеризация
- **Nginx** - веб-сервер и прокси
- **S3-совместимое хранилище** - хранение файлов

## 4. Архитектурные решения

### 4.1 Кэширование с Redis

Redis используется как основное решение для кэширования вместо встроенного Next.js кэша или LRU-cache:

```
┌─────────────────────────────────────┐
│            Next.js App              │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────┐       ┌───────────┐  │
│  │   Route   │       │  Server   │  │
│  │ Handlers  │       │ Components│  │
│  └─────┬─────┘       └─────┬─────┘  │
│        │                   │        │
│        ▼                   ▼        │
│  ┌─────────────────────────────┐    │
│  │     Cache Abstraction       │    │
│  └─────────────┬───────────────┘    │
│                │                    │
└────────────────┼────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────┐
│             Redis Cache             │
└─────────────────────────────────────┘
```

**Преимущества:**
- Распределенный кэш для горизонтального масштабирования
- Тегирование для инвалидации связанных данных
- Поддержка TTL для автоматического устаревания
- Атомарные операции для конкурентных обновлений

#### Двухуровневая система кэширования

Проект использует двухуровневую систему кэширования для обеспечения гибкости и надежности:

1. **Redis (основной уровень)**
   - Используется по умолчанию в продакшене (`CACHE_DRIVER=redis`)
   - Задействуется во всех сервисах через `getCacheAdapter()`
   - Поддерживает TTL, очистку по тегу, и используется также в BullMQ и PubSub

2. **In-memory кэш (fallback через lru-cache)**
   - Активируется при `CACHE_DRIVER=memory` (например, в dev/test окружениях)
   - Использует `lru-cache` с `max: 10000`, `ttl: 5 мин`
   - Полностью совместим по интерфейсу с Redis-адаптером
   - Применяется для изоляции от Redis и повышения стабильности тестов/локальной разработки

**Ключевые принципы:**
- Redis никогда не импортируется напрямую в сервисы
- Все обращения к кэшу идут через единый интерфейс `cache`
- Примеры использования находятся в `lib/domain` и `lib/cache/examples.js`

### 4.2 Feature-Sliced Design архитектура

Проект организован по методологии Feature-Sliced Design, которая обеспечивает предсказуемую структуру и высокую переиспользуемость:

```
src/
├── app/                    # Маршрутизация и страницы
│   ├── admin/             # Административные страницы
│   ├── api/               # API эндпоинты
│   └── layout.tsx         # Общий layout
├── features/              # Бизнес-функциональности
│   └── map-templates-management/
│       ├── api/           # Server Actions
│       └── ui/            # UI компоненты feature
├── entities/              # Бизнес-сущности
│   └── map-templates/
│       ├── model/         # Типы и mappers
│       ├── ui/            # UI компоненты сущности
│       └── lib/           # Хуки и утилиты
├── shared/                # Переиспользуемые ресурсы
│   ├── ui/                # Базовые UI компоненты
│   ├── hooks/             # Общие хуки
│   ├── providers/         # React провайдеры
│   └── admin/             # Общие административные компоненты
├── lib/                   # Бэкенд логика
│   ├── domain/            # Доменные сервисы
│   ├── repos/             # Репозитории
│   ├── cache/             # Кэширование
│   └── api/               # API утилиты и схемы
└── models/                # Mongoose модели
```

**Ключевые преимущества FSD:**
- **Переиспользуемость**: Компоненты и логика максимально переиспользуются
- **Предсказуемость**: Единый паттерн организации для всех сущностей
- **Скалируемость**: Легко добавлять новые features и entities
- **Изоляция**: Четкие границы между слоями и модулями

### 4.3 Архитектура сущностей в FSD

Каждая сущность (entity) следует единому паттерну организации:

```
entities/map-templates/
├── model/                  # Бизнес-логика сущности
│   ├── types.ts           # TypeScript типы
│   ├── mappers.ts         # Преобразование данных
│   └── index.ts           # Публичное API
├── ui/                    # UI компоненты сущности
│   ├── map-template-dialog.tsx      # Форма создания/редактирования
│   ├── map-templates-table.tsx      # Таблица с данными
│   └── index.ts           # Re-экспорты
└── lib/                   # Хуки и утилиты
    ├── use-map-templates-data.ts    # SWR хук для данных
    └── index.ts           # Публичное API
```

### 4.4 Инкрементальная статистика

Вместо пересчета статистики при каждом изменении используется инкрементальный подход:

```
┌──────────────┐     ┌───────────────┐     ┌─────────────┐
│ Завершение   │────▶│ Обновление    │────▶│ Обновление  │
│ карты        │     │ статистики    │     │ месячной    │
└──────────────┘     │ игроков       │     │ статистики  │
                     └───────────────┘     └──────┬──────┘
                                                  │
                                                  ▼
┌──────────────┐     ┌───────────────┐     ┌─────────────┐
│ Обновление   │◀────│ Обновление    │◀────│ Обновление  │
│ рейтинга     │     │ статистики    │     │ годовой     │
│              │     │ семей         │     │ статистики  │
└──────────────┘     └───────────────┘     └─────────────┘
```

- Текущий год хранится в `currentYearStats` и обновляется инкрементально
- Завершенные годы "замораживаются" в `yearlyArchive`
- Месячная статистика обновляется при каждом участии

### 4.5 Полнотекстовый поиск с Meilisearch

Интегрирован Meilisearch для мгновенного поиска по всем сущностям:

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   User Action   │───▶│   API Endpoint   │───▶│  Search Service │
│ (поиск карт)    │    │ /api/admin/search│    │                 │
└─────────────────┘    └──────────────────┘    └────────┬────────┘
                                                        │
                                                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Результаты     │◀───│   SWR кэш        │◀───│   Meilisearch   │
│ в UI            │    │ (клиентский)     │    │   (сервер)      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

**Особенности:**
- Автоматическая синхронизация при изменении данных через BullMQ очереди
- Поддержка поиска по множественным сущностям одним запросом
- Переиспользуемый компонент `EntitySearch` для всех административных страниц

## 5. Интеграция с Redis

Redis выполняет несколько ключевых функций в архитектуре:

1. **Распределенное кэширование** - основной механизм кэширования для API и данных
   - Кэширование API ответов с TTL
   - Кэширование серверных компонентов
   - Инвалидация по тегам при изменении данных

2. **Очереди задач (BullMQ)** - фоновая обработка
   - Синхронизация данных с Meilisearch
   - Генерация отчетов и статистики
   - Отложенные уведомления

3. **Pub/Sub для уведомлений** - система реального времени
   - Уведомления о создании/завершении турниров и карт
   - Обновления статистики и рейтингов
   - Интеграция с WebSocket для клиентских уведомлений (post-MVP)

4. **Rate limiting** - ограничение частоты запросов к API
   - Защита от DoS атак
   - Разные лимиты для разных эндпоинтов
   - Скользящее окно для точного подсчета

5. **Хранение сессий** - управление сессиями пользователей
   - Хранение NextAuth.js сессий
   - CSRF токены для защиты форм
   - Временные данные с TTL

## 6. Масштабируемость

Архитектура спроектирована для горизонтального масштабирования:

```
┌───────────────┐
│  Load         │
│  Balancer     │
└───┬───────┬───┘
    │       │
┌───▼───┐ ┌─▼─────┐
│App 1  │ │App 2  │
└───┬───┘ └───┬───┘
    │         │
┌───▼─────────▼───┐
│    Redis        │
│   (shared)      │
└───┬─────────┬───┘
    │         │
┌───▼───┐ ┌───▼───┐
│MongoDB│ │MongoDB│
│(rs)   │ │(rs)   │
└───────┘ └───────┘
```

- Stateless Next.js приложения за балансировщиком
- Распределенный Redis для кэширования и коммуникации
- MongoDB Replica Set для высокой доступности

## 7. Безопасность

- **HTTPS** с Let's Encrypt сертификатами
- **CSP** для защиты от XSS атак
- **Rate Limiting** для защиты от брутфорс атак
- **CSRF** защита для всех мутирующих операций
- **Валидация** всех входных данных с Zod
- **Role-based** контроль доступа
- **Аудит** всех административных действий

## 8. Roadmap

### 8.1 Post-MVP функциональности

- **WebSocket интеграция** - real-time уведомления и обновления
  - Уведомления о создании/завершении турниров и карт
  - Live-обновления статистики и рейтингов
  - Интеграция с Redis Pub/Sub для масштабируемости

- **Расширенная аналитика** - детальные отчеты и визуализации
  - Графики прогресса игроков и семей
  - Тепловые карты активности
  - Экспорт данных в различные форматы

## 9. Технические особенности

- **Кодовая база** - TypeScript с строгой типизацией
- **Тестирование** - Vitest + Testing Library для интеграционных тестов
- **Линтинг** - ESLint с TypeScript правилами
- **Feature-Sliced Design** - предсказуемая архитектура фронтенда
- **React 19** - современные хуки (useActionState, useFormStatus)
- **Server Actions** - прогрессивное улучшение форм 