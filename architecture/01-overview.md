# Архитектура MajesticMatchCenter: Обзор

## 1. Архитектурный стиль

MajesticMatchCenter использует **гексагональную архитектуру** (Ports and Adapters) с элементами **доменно-ориентированного проектирования (DDD)**. Это обеспечивает:

- Четкое разделение бизнес-логики от инфраструктуры
- Возможность замены внешних систем без изменения ядра приложения
- Улучшенную тестируемость через абстракции

## 2. Ключевые архитектурные слои

1. **Пользовательский интерфейс (UI)**
   - React Server Components (RSC) для серверного рендеринга
   - Client Components для интерактивных элементов
   - Atomic Design для структурирования компонентов

2. **API слой**
   - Route Handlers (REST API)
   - Server Actions для форм
   - WebSocket для real-time уведомлений (post-MVP)

3. **Доменный слой**
   - Сервисы с бизнес-логикой
   - Модели предметной области
   - Репозитории для доступа к данным

4. **Инфраструктурный слой**
   - MongoDB для хранения данных
   - Redis для кэширования и real-time коммуникации
   - S3-совместимое хранилище для файлов

## 3. Технологический стек

### 3.1 Frontend

- **Next.js 15** - фреймворк для React с серверными компонентами
- **React 19** - библиотека для создания UI
- **TailwindCSS** - утилитарный CSS фреймворк
- **shadcn/ui** - компонентная библиотека
- **React Hook Form** - управление формами
- **Zod** - валидация данных
- **@tanstack/react-query** - кэширование и получение данных
- **JavaScript** - проект реализован без TypeScript

### 3.2 Backend

- **Next.js API Routes** - серверный API
- **Mongoose 8** - ODM для MongoDB
- **Redis Node.js Client** - работа с Redis
- **NextAuth.js с Yandex ID** - аутентификация и авторизация
- **Winston** - логирование

### 3.3 Инфраструктура

- **MongoDB 7** - основная база данных
- **Redis 7** - кэширование, pub/sub, rate limiting
- **Docker** - контейнеризация
- **Nginx** - веб-сервер и прокси
- **S3-совместимое хранилище** - хранение файлов

## 4. Архитектурные решения

### 4.1 Кэширование с Redis

Redis используется как основное решение для кэширования вместо встроенного Next.js кэша или LRU-cache:

```
┌─────────────────────────────────────┐
│            Next.js App              │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────┐       ┌───────────┐  │
│  │   Route   │       │  Server   │  │
│  │ Handlers  │       │ Components│  │
│  └─────┬─────┘       └─────┬─────┘  │
│        │                   │        │
│        ▼                   ▼        │
│  ┌─────────────────────────────┐    │
│  │     Cache Abstraction       │    │
│  └─────────────┬───────────────┘    │
│                │                    │
└────────────────┼────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────┐
│             Redis Cache             │
└─────────────────────────────────────┘
```

**Преимущества:**
- Распределенный кэш для горизонтального масштабирования
- Тегирование для инвалидации связанных данных
- Поддержка TTL для автоматического устаревания
- Атомарные операции для конкурентных обновлений

#### Двухуровневая система кэширования

Проект использует двухуровневую систему кэширования для обеспечения гибкости и надежности:

1. **Redis (основной уровень)**
   - Используется по умолчанию в продакшене (`CACHE_DRIVER=redis`)
   - Задействуется во всех сервисах через `getCacheAdapter()`
   - Поддерживает TTL, очистку по тегу, и используется также в BullMQ и PubSub

2. **In-memory кэш (fallback через lru-cache)**
   - Активируется при `CACHE_DRIVER=memory` (например, в dev/test окружениях)
   - Использует `lru-cache` с `max: 10000`, `ttl: 5 мин`
   - Полностью совместим по интерфейсу с Redis-адаптером
   - Применяется для изоляции от Redis и повышения стабильности тестов/локальной разработки

**Ключевые принципы:**
- Redis никогда не импортируется напрямую в сервисы
- Все обращения к кэшу идут через единый интерфейс `cache`
- Примеры использования находятся в `lib/domain` и `lib/cache/examples.js`

### 4.2 Доменно-ориентированная структура

Проект организован по доменным областям вместо технических слоев:

```
src/
├── app/                    # Next.js App Router
├── components/             # React компоненты
├── lib/                    # Общие утилиты
│   ├── cache/              # Абстракция кэширования
│   ├── domain/             # Доменные сервисы
│   ├── repos/              # Репозитории
│   └── api/                # API утилиты и схемы
└── models/                 # Mongoose модели
    ├── tournament/         # Модели и сервисы турниров
    ├── map/                # Модели и сервисы карт
    ├── family/             # Модели и сервисы семей
    └── player/             # Модели и сервисы игроков
```

### 4.3 Модульная архитектура компонентов

Компоненты организованы по паттерну Container/View/Hook:

```
components/
├── admin/
│   └── MapForm_new/
│       ├── components/     # Презентационные компоненты
│       │   ├── MapFormBasicFields.jsx
│       │   ├── MapFormParticipants.jsx
│       │   └── MapFormStatistics.jsx
│       ├── hooks/          # Хуки с логикой
│       │   ├── useMapForm.js
│       │   └── useParticipants.js
│       ├── utils/          # Утилиты
│       │   └── mapFormHelpers.js
│       ├── MapFormContainer.jsx  # Контейнер с состоянием
│       └── MapFormView.jsx       # Презентационный компонент
```

### 4.4 Инкрементальная статистика

Вместо пересчета статистики при каждом изменении используется инкрементальный подход:

```
┌──────────────┐     ┌───────────────┐     ┌─────────────┐
│ Завершение   │────▶│ Обновление    │────▶│ Обновление  │
│ карты        │     │ статистики    │     │ месячной    │
└──────────────┘     │ игроков       │     │ статистики  │
                     └───────────────┘     └──────┬──────┘
                                                  │
                                                  ▼
┌──────────────┐     ┌───────────────┐     ┌─────────────┐
│ Обновление   │◀────│ Обновление    │◀────│ Обновление  │
│ рейтинга     │     │ статистики    │     │ годовой     │
│              │     │ семей         │     │ статистики  │
└──────────────┘     └───────────────┘     └─────────────┘
```

- Текущий год хранится в `currentYearStats` и обновляется инкрементально
- Завершенные годы "замораживаются" в `yearlyArchive`
- Месячная статистика обновляется при каждом участии

## 5. Интеграция с Redis

Redis выполняет несколько ключевых функций в архитектуре:

1. **Распределенное кэширование** - основной механизм кэширования для API и данных
   - Кэширование API ответов с TTL
   - Кэширование серверных компонентов
   - Инвалидация по тегам при изменении данных

2. **Pub/Sub для уведомлений** - система реального времени
   - Уведомления о создании/завершении турниров и карт
   - Обновления статистики и рейтингов
   - Интеграция с WebSocket для клиентских уведомлений (post-MVP)

3. **Rate limiting** - ограничение частоты запросов к API
   - Защита от DoS атак
   - Разные лимиты для разных эндпоинтов
   - Скользящее окно для точного подсчета

4. **Хранение сессий** - управление сессиями пользователей
   - Хранение NextAuth.js сессий
   - CSRF токены для защиты форм
   - Временные данные с TTL

## 6. Масштабируемость

Архитектура спроектирована для горизонтального масштабирования:

```
┌───────────────┐
│  Load         │
│  Balancer     │
└───┬───────┬───┘
    │       │
┌───▼───┐ ┌─▼─────┐
│App 1  │ │App 2  │
└───┬───┘ └───┬───┘
    │         │
┌───▼─────────▼───┐
│    Redis        │
│   (shared)      │
└───┬─────────┬───┘
    │         │
┌───▼───┐ ┌───▼───┐
│MongoDB│ │MongoDB│
│(rs)   │ │(rs)   │
└───────┘ └───────┘
```

- Stateless Next.js приложения за балансировщиком
- Распределенный Redis для кэширования и коммуникации
- MongoDB Replica Set для высокой доступности

## 7. Безопасность

- **HTTPS** с Let's Encrypt сертификатами
- **CSP** для защиты от XSS атак
- **Rate Limiting** для защиты от брутфорс атак
- **CSRF** защита для всех мутирующих операций
- **Валидация** всех входных данных с Zod
- **Role-based** контроль доступа
- **Аудит** всех административных действий

## 8. Roadmap

### 8.1 Post-MVP функциональности

- **WebSocket интеграция** - real-time уведомления и обновления
  - Уведомления о создании/завершении турниров и карт
  - Live-обновления статистики и рейтингов
  - Интеграция с Redis Pub/Sub для масштабируемости

- **Расширенная аналитика** - детальные отчеты и визуализации
  - Графики прогресса игроков и семей
  - Тепловые карты активности
  - Экспорт данных в различные форматы

## 9. Технические особенности

- **Кодовая база** - JavaScript ES2022 (без TypeScript) 