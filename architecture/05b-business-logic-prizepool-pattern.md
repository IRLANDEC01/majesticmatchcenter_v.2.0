# Паттерн "Призовые уровни" (Prize Tiers)

Этот документ описывает стандартную структуру данных и бизнес-логику для распределения призового фонда в турнирах. Цель — обеспечить максимальную гибкость для администраторов без необходимости изменения кода.

## 1. Структура данных (`prizePool`)

Поле `prizePool` в модели `Tournament` является массивом объектов, где каждый объект представляет собой одно "правило" или "уровень" награды. Существует два основных типа правил, которые могут комбинироваться.

### 1.1. `tierType: 'rank'` — Приз за ранг

Это правило награждает участников, занявших определенные места.

**Схема объекта:**
```javascript
{
  tierType: { type: String, enum: ['rank', 'remainder_pot'], required: true },
  // Правило применяется к участникам, чей ранг находится в этом диапазоне (включительно)
  ranks: {
    from: { type: Number, required: true, min: 1 },
    to: { type: Number, required: true, min: 1 },
  },
  // Награда, которую получит КАЖДЫЙ участник в этом диапазоне
  reward: {
    amount: { type: Number, required: true, min: 0 },
    currency: { type: String, required: true, enum: ['MajesticCoins'] } // Используем константы
  }
}
```

**Пример 1: Награда только для победителя**
```json
[{
  "tierType": "rank",
  "ranks": { "from": 1, "to": 1 },
  "reward": { "amount": 1000, "currency": "MajesticCoins" }
}]
```

**Пример 2: Награды для топ-3**
```json
[
  { "tierType": "rank", "ranks": { "from": 1, "to": 1 }, "reward": { "amount": 500, "currency": "MajesticCoins" } },
  { "tierType": "rank", "ranks": { "from": 2, "to": 3 }, "reward": { "amount": 250, "currency": "MajesticCoins" } }
]
```

### 1.2. `tierType: 'remainder_pot'` — Общий котел для остальных

Это правило описывает общую сумму, которая будет разделена **поровну** между всеми участниками, которые **не получили** приз за ранг. В массиве `prizePool` может быть не более одного такого правила.

**Схема объекта:**
```javascript
{
  tierType: { type: String, enum: ['rank', 'remainder_pot'], required: true },
  // Общая сумма для разделения
  pot: {
    amount: { type: Number, required: true, min: 1 },
    currency: { type: String, required: true, enum: ['MajesticCoins'] }
  }
}
```

**Пример: 1000 монет для победителя, а еще 1000 делятся между остальными**
```json
[
  { "tierType": "rank", "ranks": { "from": 1, "to": 1 }, "reward": { "amount": 1000, "currency": "MajesticCoins" } },
  { "tierType": "remainder_pot", "pot": { "amount": 1000, "currency": "MajesticCoins" } }
]
```

## 2. Бизнес-логика обработки

Процесс распределения призов при завершении турнира (`completeTournament`):

1.  **Получить итоговый лидерборд** — отсортированный список участников с их финальными рангами.
2.  **Инициализировать "карту награжденных"** — создать пустой объект или `Map`, чтобы отслеживать, кто уже получил приз.
3.  **Обработать ранговые призы (`tierType: 'rank'`)**:
    *   Пройти по каждому правилу `rank`.
    *   Для каждого правила найти в лидерборде участников, чей ранг попадает в диапазон `ranks.from` - `ranks.to`.
    *   Для каждого найденного участника создать запись `FamilyEarning` / `PlayerEarning` с указанной наградой `reward`.
    *   Добавить `familyId` каждого награжденного участника в "карту награжденных".
4.  **Обработать "общий котел" (`tierType: 'remainder_pot'`)**:
    *   Найти правило `remainder_pot` (оно может быть только одно).
    *   Если правило существует:
        *   Отфильтровать лидерборд, оставив только тех участников, которых **нет** в "карте награжденных".
        *   Посчитать количество оставшихся участников (`N`).
        *   Рассчитать индивидуальную награду: `individualAmount = Math.floor(pot.amount / N)`. Используем `floor`, чтобы избежать дробных частей монет.
        *   Для каждого из `N` участников создать запись о награде с `individualAmount`.
5.  **Все операции по созданию записей** о наградах (`...Earning`) и обновлению `FamilyTournamentParticipation` должны выполняться внутри **атомарной транзакции** для обеспечения целостности данных.

## 3. Пользовательский интерфейс (UI)

В админ-панели для управления призовым фондом рекомендуется реализовать следующий интерактивный компонент:

1.  **Поле "Общий бюджет"**: Администратор вводит общую сумму призового фонда.
2.  **Счетчик "Осталось распределить"**: Число, которое в реальном времени показывает `Общий бюджет - Сумма всех распределенных призов`.
3.  **Динамический конструктор правил**:
    *   Кнопка `[+ Добавить приз за ранг]`.
    *   Кнопка `[+ Распределить остаток между другими]`, которая автоматически создает правило `remainder_pot` с текущим значением счетчика.
4.  **Валидация**: Интерфейс должен подсвечивать ошибки, если сумма распределенных призов превышает общий бюджет. 