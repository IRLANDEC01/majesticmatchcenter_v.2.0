# Бизнес-логика: Карты и Шаблоны Карт

Этот документ описывает бизнес-правила и жизненный цикл сущностей `Map` и `MapTemplate`.

*Данный документ является источником правды. Любые изменения в логике сначала вносятся сюда.*

---

## 1. Шаблон Карты (MapTemplate)

Шаблон карты — это "чертеж" для создания отдельных карт в рамках турниров. Он определяет название, изображение и другие базовые параметры карты.

### 1.1. Жизненный цикл

*   **Создание и Редактирование:** При создании `Карты` на основе `MapTemplate`, все данные из шаблона **копируются** в новую карту. Дальнейшие изменения в шаблоне **не влияют** на уже созданные карты.
*   **Архивация:**
    *   **Правило 1.1.1:** Шаблон можно архивировать в любой момент. Это не повлияет на уже существующие карты.
    *   **Правило 1.1.2:** Нельзя использовать заархивированный шаблон при создании новых карт.

## 2. Карта (Map)

Карта — это отдельный матч или раунд в рамках более крупного `Турнира`.

### 2.1. Жизненный цикл

*   **Создание:**
    *   **Правило 2.1.1 (Исправлено):** Карты создаются **только вручную** администратором в рамках существующего `Турнира`.
    *   **Правило 2.1.2:** При создании администратор обязан выбрать один из `MapTemplate`, которые разрешены в родительском `TournamentTemplate`.
    *   **Начальный статус:** `PLANNED`.

*   **Активная фаза (статус `ACTIVE`):**
    *   **Правило 2.1.3 (Исправлено):** Карта переходит в статус `ACTIVE` **только автоматически** при наступлении времени, указанного в поле `startDateTime`. Администратор не может перевести карту в этот статус вручную.

*   **Завершение (статус `COMPLETED`):**
    *   **Правило 2.1.4 (Ключевое):** Карта завершается **только вручную** администратором через специальный интерфейс.
    *   **Правило 2.1.5 (Новое):** Запрещено переводить карту в статус `COMPLETED`, если ее текущий статус `PLANNED`. Карта должна сначала автоматически стать `ACTIVE`.
    *   При завершении администратор вводит итоговые данные матча.

### 2.2. Результаты карты и начисление рейтинга

Это ключевой процесс, который фиксирует итоги матча.

*   **Правило 2.2.1:** При переводе карты в статус `COMPLETED` администратор **вручную вводит** данные по каждому участнику (семье или временной команде).
*   **Вводимые данные:**
    1.  **Место (Rank):** Итоговое место участника на этой конкретной карте.
    2.  **Очки рейтинга (`ratingChange`):** Количество очков, которое будет добавлено к глобальному рейтингу семьи. **Важно:** для временных команд это поле игнорируется, так как у них нет глобального рейтинга.
    3.  **Турнирные очки (`tournamentPoints`):** Количество очков, которое идет в зачет таблицы результатов текущего турнира. Это значение актуально для всех типов участников.
*   **Правило 2.2.2:** После подтверждения этих данных система создает записи в коллекциях `FamilyMapParticipation` и/или `PlayerMapParticipation`, которые служат "источником правды" для истории и статистики.
*   **Правило 2.2.3:** Рейтинг семьи (`Family.rating`) и ее статистика (`Family.stats`) обновляются на основе введенного значения `ratingChange`.

*   **Архивация:**
    *   **Правило 2.2.4:** Завершенную карту можно архивировать, но, как правило, это действие выполняется на уровне всего турнира.
    *   **Правило 2.2.5 (Новое):** Права на архивацию карты в будущем будут принадлежать только роли `superadmin`. 