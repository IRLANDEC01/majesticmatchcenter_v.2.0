# Бизнес-логика: Турниры и Шаблоны Турниров

Этот документ описывает бизнес-правила и жизненный цикл сущностей `Tournament` и `TournamentTemplate`.

*Данный документ является источником правды. Любые изменения в логике сначала вносятся сюда.*

---

## 1. Шаблон Турнира (TournamentTemplate)

Шаблон турнира — это "чертеж" для быстрого создания однотипных турниров.

### 1.1. Жизненный цикл

*   **Создание и Редактирование:** При создании `Турнира` на основе `TournamentTemplate`, все данные из шаблона **копируются** в новый турнир. Дальнейшие изменения в шаблоне **не влияют** на уже созданные турниры.
*   **Архивация:**
    *   **Правило 1.1.1:** Шаблон можно архивировать в любой момент. Это не повлияет на уже существующие турниры.
    *   **Правило 1.1.2:** Заархивированный шаблон нельзя выбрать при создании нового турнира.

## 2. Турнир (Tournament)

Турнир — это конкретное соревнование, созданное на основе шаблона.

### 2.1. Типы турниров и участники

Существует два типа турниров, которые определяют, кто может в них участвовать. Тип задается при создании турнира и не может быть изменен.

*   **Тип 1: Семейный (Family-based)**
    *   **Участники:** Постоянные `Семьи` (Families) из основной базы данных.
    *   **Применение:** Основные рейтинговые лиги и регулярные соревнования.

*   **Тип 2: Событийный (Event-based / Team-based)**
    *   **Участники:** Временные команды, созданные специально для этого турнира. Название команды и состав игроков определяются на этапе регистрации на турнир и хранятся внутри документа `Tournament`.
    *   **Применение:** Специальные ивенты, шоу-матчи, где игроки могут объединяться в произвольные команды.

### 2.2. Жизненный цикл

*   **Создание:**
    *   **Правило 2.2.1:** Турнир создается из `TournamentTemplate`. При создании копируются все основные настройки (snapshot).
    *   **Правило 2.2.2:** Администратор указывает дату начала и тип турнира (`Семейный` или `Событийный`).
    *   **Правило 2.2.3 (Исправлено):** Создание турнира **не создает карты автоматически**. Оно лишь определяет **пул доступных шаблонов карт**, из которых администратор сможет вручную создавать карты для этого турнира.
    *   **Начальный статус:** `PLANNED`.

*   **Регистрация (статус `PLANNED`):**
    *   Администратор регистрирует участников (Семьи или временные команды) в соответствии с типом турнира.
    *   На этом этапе можно редактировать любые параметры турнира.

*   **Активная фаза (статус `ACTIVE`):**
    *   **Правило 2.2.4 (Исправлено):** Турнир переходит в статус `ACTIVE` **только автоматически** при наступлении времени, указанного в поле `startDate`. Администратор не может перевести турнир в этот статус вручную.
    *   **Правило 2.2.5:** С момента перехода в статус `ACTIVE` редактирование ключевых параметров турнира (название, даты, участники) блокируется.

*   **Завершение (статус `COMPLETED`):**
    *   **Правило 2.2.6 (Ключевое):** Турнир **НЕ завершается автоматически**.
    *   **Правило 2.2.7:** Администратор может перевести турнир в статус `COMPLETED` только **вручную** и только при выполнении условия: **все карты (`Map`), принадлежащие этому турниру, имеют статус `COMPLETED`**.
    *   После завершения турнира происходит финальный подсчет очков и определение победителей.

*   **Архивация:**
    *   **Правило 2.2.8:** Завершенный турнир можно архивировать для скрытия из основных списков.
    *   **Правило 2.2.9 (Новое):** Права на архивацию турнира в будущем будут принадлежать только роли `superadmin`.

## 3. Управление Картами в Турнире

*   **Правило 3.1 (Исправлено):** Карты турнира проводятся в хронологическом порядке, который определяется их временем начала (`startDateTime`). Система не накладывает ограничений на начало следующей карты, если предыдущая не завершена. Ответственность за логичное расписание лежит на администраторе.
*   **Правило 3.2:** Администратор может создать все карты турнира заранее (со статусом `PLANNED`).
*   **Правило 3.3:** Результаты каждой карты (очки, рейтинг) влияют на общую таблицу результатов турнира. 