# Бизнес-логика MajesticMatchCenter
ВНИМАНИЕ - бизнес логика будет постоянно улучшаться и моджернизироваться. если захочешь использовать существующую здесь структуру и патернры - сначала спроси меня для окончательного подтверждения
## 1. Доменная модель

### 1.1 Ключевые сущности

#### Tournament (Турнир)
- **Роль**: Центральная сущность, представляющая соревновательное мероприятие, объединяющее участников и игровые сессии.
- **Назначение**: Организация и структурирование соревновательного процесса, отслеживание участников, определение победителей и распределение призов.
- **Типы турниров**:
  - **Семейные турниры**: Участниками выступают существующие семьи со своими игроками. Используют долгосрочные объединения игроков.
  - **Командные турниры**: Участниками выступают временно созданные команды, объединяющие существующих игроков только на период турнира. Команды не сохраняются как отдельные сущности в базе данных.
- **Жизненный цикл**: planned → active → completed
- **Связи**: Содержит карты (Maps), связан с семьями (Families) и/или командами (Teams) через участников.
- **Ключевые атрибуты**:
  - `name`: Название турнира
  - `slug`: URL-friendly идентификатор
  - `description`: Описание турнира
  - `startDate`: Дата начала турнира
  - `endDate`: Дата окончания турнира (может быть null для открытых турниров)
  - `status`: Статус турнира (planned, active, completed)
  - `template`: Ссылка на шаблон турнира
  - `participantFamilies`: Массив семей-участников
  - `participantTeams`: Массив команд-участников
  - `maps`: Массив карт в турнире
  - `winner`: Победитель турнира (семья или команда)
  - `disableAutoActivation`: Флаг отключения автоматической активации (bool, default=true)

#### Map (Карта)
- **Роль**: Конкретная игровая сессия, проводимая в рамках турнира.
- **Назначение**: Фиксация результатов отдельного матча, сбор статистики игроков, определение победителя конкретной игры.
- **Жизненный цикл**: planned → active → completed
- **Связи**: Принадлежит турниру, содержит участвующие семьи/команды с игроками и их статистикой.
- **Ключевые атрибуты**:
  - `name`: Название карты
  - `slug`: URL-friendly идентификатор
  - `tournament`: Ссылка на турнир
  - `template`: Ссылка на шаблон карты
  - `startDateTime`: Дата и время начала
  - `status`: Статус карты (planned, active, completed)
  - `participantFamilies`: Массив семей-участников
  - `participantTeams`: Массив команд-участников
  - `winner`: Победитель карты (семья или команда)
  - `mvp`: Самый ценный игрок карты
  - `ratingChanges`: Изменения рейтинга после карты
  - `disableAutoActivation`: Флаг отключения автоматической активации (bool, default=true)

#### Family (Семья)
- **Роль**: Постоянное объединение игроков, представляющее собой устойчивую команду.
- **Назначение**: Группировка игроков в долгосрочные коллективы, отслеживание общего рейтинга и достижений команды.
- **Особенности**: Имеет историю членства, рейтинг, собственную идентичность (логотип, баннер).
- **Связи**: Состоит из игроков (Players), участвует в турнирах и картах, имеет историю рейтинга.
- **Ключевые атрибуты**:
  - `name`: Название семьи
  - `slug`: URL-friendly идентификатор
  - `description`: Описание семьи
  - `logo`: Логотип семьи
  - `rating`: Рейтинг семьи
  - `status`: Статус семьи (active, inactive)
  - `members`: Массив участников семьи
  - `socialLinks`: Социальные сети семьи

#### Team (Команда)
- **Роль**: Временное объединение игроков для участия в конкретном турнире.
- **Назначение**: Группировка игроков для командных турниров без создания постоянной семьи.
- **Особенности**: Существует только в контексте турнира, не имеет отдельной схемы в базе данных, не хранит историю членства или рейтинг.
- **Реализация**: Хранится как часть структуры данных турнира (participantTeams) и карт, не является отдельной коллекцией в базе данных.

#### Player (Игрок)
- **Роль**: Базовая сущность, представляющая реального участника игровых сессий.
- **Назначение**: Отслеживание индивидуальной статистики, рейтинга и достижений игрока.
- **Особенности**: Может менять принадлежность к семьям с течением времени, накапливает личную статистику.
- **Связи**: Может принадлежать семье, участвует в картах и турнирах, имеет историю рейтинга и статистику по оружию.
- **Ключевые атрибуты**:
  - `firstName`: Имя игрока
  - `lastName`: Фамилия игрока
  - `slug`: URL-friendly идентификатор
  - `nickname`: Игровой ник
  - `avatar`: Аватар игрока
  - `rating`: Рейтинг игрока
  - `status`: Статус игрока (active, inactive)
  - `currentFamily`: Текущая семья игрока

#### News (Новость)
- **Роль**: Информационная сущность для публикации новостей и объявлений.
- **Назначение**: Информирование пользователей о событиях, турнирах, изменениях и других важных новостях.
- **Особенности**: Имеет категории, теги, может содержать изображения и форматированный текст.
- **Связи**: Может быть связана с турнирами, картами, семьями и игроками через теги или прямые ссылки.

### 1.2 Связи между сущностями

```
Tournament 1──────n Map
    │                │
    │                │
    ▼                ▼
Family ◄────────► Player
    ▲                ▲
    │                │
    └───── News ─────┘
```

#### Описание связей

1. **Tournament — Map** (один-ко-многим):
   - Один турнир содержит множество карт
   - Каждая карта принадлежит только одному турниру
   - Турнир агрегирует результаты всех своих карт
   - При удалении турнира удаляются все связанные карты

2. **Tournament — Family** (многие-ко-многим):
   - Турнир может включать множество семей как участников
   - Семья может участвовать во множестве турниров
   - Включает дополнительные данные об участии (позиция, победитель)

3. **Map — Family** (многие-ко-многим):
   - Карта включает множество семей как участников
   - Семья может участвовать во множестве карт
   - Включает детальную статистику участия семьи в конкретной карте

4. **Family — Player** (один-ко-многим с историей):
   - Семья может включать множество игроков
   - Игрок в конкретный момент времени может принадлежать только одной семье
   - Игрок может менять принадлежность к семьям с течением времени
   - История членства сохраняется для аналитики и отображения

5. **Map — Player** (многие-ко-многим):
   - Карта включает множество игроков как участников
   - Игрок может участвовать во множестве карт
   - Связь реализована через вложенные массивы `participantFamilies.players` и `participantTeams.players` в модели Map
   - Игрок не может самостоятельно участвовать в карте, только в составе семьи или команды
   - К семье можно добавить только игроков из этой семьи, к команде можно добавить любых существующих игроков
   - Включает детальную игровую статистику (убийства, смерти, урон)

6. **News — Family/Player/Tournament/Map** (многие-ко-многим):
   - Новость может упоминать множество семей, игроков, турниров и карт
   - Семья, игрок, турнир или карта могут упоминаться во множестве новостей
   - При создании новости используется функционал упоминания (ссылки на публичные страницы)
   - Новости, в которых упоминаются сущности, сохраняются в базе данных этих сущностей
   - На публичных страницах сущностей отображается колонка с упоминающими их новостями
   - Связь реализована через теги и прямые ссылки в контенте новостей

7. **TournamentTemplate — Tournament** (один-ко-многим):
   - Шаблон турнира используется как основа для создания конкретных турниров
   - Один шаблон может быть использован для создания множества турниров
   - Шаблон содержит базовые настройки и параметры для турниров
   - При создании турнира на основе шаблона копируются настройки и параметры

8. **MapTemplate — Map** (один-ко-многим):
   - Шаблон карты используется как основа для создания конкретных карт
   - Один шаблон может быть использован для создания множества карт
   - Шаблон содержит базовые настройки и параметры для карт
   - При создании карты на основе шаблона копируются настройки и параметры

### 1.3 Шаблоны турниров и карт

#### TournamentTemplate (Шаблон турнира)
- **Роль**: Предопределенная конфигурация для создания турниров
- **Назначение**: Упрощение и стандартизация процесса создания турниров
- **Реализация**: Модель `src/models/tournament/TournamentTemplate.js`
- **Ключевые атрибуты**:
  - **name**: Название шаблона
  - **slug**: Уникальный идентификатор для URL
  - **description**: Описание шаблона
  - **rules**: Правила проведения турнира
  - **defaultPrize**: Стандартный призовой фонд
  - **defaultImage**: Изображение по умолчанию
  - **usageCount**: Счетчик использования шаблона
- **Функциональность**:
  - При создании турнира администратор выбирает шаблон
  - Настройки из шаблона копируются в новый турнир
  - Счетчик `usageCount` инкрементируется атомарной операцией
  - Номер турнира формируется на основе `usageCount` (например, "mcl-3")
  - Ведется подсчет всех сыгранных турниров с использованием данного шаблона
  - Доступна аналитика по популярности шаблонов и успешности турниров

#### MapTemplate (Шаблон карты)
- **Роль**: Предопределенная конфигурация для создания карт
- **Назначение**: Упрощение и стандартизация процесса создания карт
- **Реализация**: Модель `src/models/map/MapTemplate.js`
- **Ключевые атрибуты**:
  - **name**: Название шаблона
  - **slug**: Уникальный идентификатор для URL
  - **description**: Описание шаблона
  - **gameMode**: Режим игры
  - **mapImage**: Изображение карты
  - **defaultSettings**: Стандартные настройки
  - **usageCount**: Счетчик использования шаблона
- **Функциональность**:
  - При создании карты администратор выбирает шаблон
  - Настройки из шаблона копируются в новую карту
  - Счетчик `usageCount` инкрементируется атомарной операцией
  - Номер карты формируется на основе номера турнира и счетчика карт в турнире (например, "mcl-3-map-2")
  - Ведется подсчет всех сыгранных карт с использованием данного шаблона
  - Доступна статистика по популярности шаблонов карт и их результативности

#### Преимущества использования шаблонов
- **Стандартизация**: Все турниры и карты одного типа имеют одинаковую структуру
- **Эффективность**: Ускорение процесса создания новых турниров и карт
- **Согласованность**: Единообразие в настройках и правилах
- **Аналитика**: Возможность отслеживания популярности различных типов турниров и карт

### 1.4 Паттерн хранения достижений и наград

Для управления наградами (MVP, лучший стрелок и т.д.) в проекте используется **гибридный подход**, сочетающий централизованное хранение и денормализацию для оптимизации производительности.

**Компоненты паттерна:**

1.  **Центральный хаб (`PlayerAchievement.js`)**
    *   **Роль:** Единый и основной источник правды для **всех** достижений в системе.
    *   **Реализация:** Отдельная коллекция `playerachievements`, где каждая запись — это конкретное достижение, привязанное к игроку и, опционально, к турниру или карте.
    *   **Использование:** Применяется для получения полного списка наград игрока, для построения сложных аналитических отчетов и ведения "Зала славы".

2.  **Прямые денормализованные ссылки**
    *   **Роль:** Ускоренный доступ к наиболее важным и часто запрашиваемым наградам.
    *   **Реализация:** Прямая ссылка на игрока ( `mvp: { type: ObjectId, ref: 'Player' }`) добавляется непосредственно в схему родительской сущности (`Tournament.js`, `Map.js`).
    *   **Использование:** Применяется для быстрого отображения MVP на странице турнира или карты без необходимости выполнять дополнительные запросы (`$lookup`) к коллекции достижений.

**Правило применения:**

*   **При завершении карты/турнира:**
    1.  Ссылка на MVP **обязательно** сохраняется в поле `mvp` в документе `Map` или `Tournament`.
    2.  Одновременно с этим создается новая запись в коллекции `PlayerAchievement` с соответствующим типом (`map_mvp` или `tournament_mvp`).
    3.  Для **всех остальных** наград ("лучший по убийствам", "топ-фраггер" и т.д.) создаются только записи в `PlayerAchievement`.

Этот гибридный подход обеспечивает как высокую производительность на чтение для частых сценариев, так и гибкость и целостность данных для аналитики.

## 2. Ключевые бизнес-процессы

### 2.1 Управление турнирами

#### Создание турнира
1. Администратор создает турнир с базовой информацией
2. Выбирает шаблон турнира
3. Добавляет семьи/команды
4. Устанавливает призовой фонд (опционально)
5. Устанавливает дату начала турнира
6. Публикует турнир (статус автоматически устанавливается как planned)

#### Автоматическая активация турнира
1. Система автоматически меняет статус на active, когда наступает дата начала турнира
3. Турнир становится доступен для создания карт

#### Изменение расписания
1. Администратор может изменить дату начала турнира
2. Система автоматически корректирует статус в зависимости от новой даты:
   - Если новая дата в будущем и турнир активен - статус  меняется на planned
   - Если новая дата в будущем и турнир planned - статус остается planned
   - Если новая дата в прошлом и турнир planned - статус меняется на active

#### Завершение турнира
1. Администратор меняет статус на completed (только вручную)
2. Система проверяет чтобы все карты были завершены
3. Администратор выбирает победителя   (семья или команда) и mvp среди игроков победившей семьи
4. Администратор распределяет призовой фонд между участниками (семьями или командами)
5. Обновляется статистика участников


### 2.2 Управление картами

#### Создание карты
1. Администратор создает карту в рамках активного турнира.
2. Выбирает шаблон, устанавливает дату и время.
3. Добавляет участников (семьи/команды) из списка участников родительского турнира.
   - **Обязательное условие:** Должен быть добавлен хотя бы один участник.
4. Для каждого участника выбирает конкретных игроков, которые будут играть.
   - **Обязательное условие:** Для каждого участника должен быть выбран хотя бы один игрок.
   - **Проверка:** Если турнир `family`, игроки выбираются только из состава семьи. Если `team` — из всей базы данных.
5. Публикует карту.
6. **Система:** Автоматически устанавливает статус `planned` или `active` на основе `startDateTime`.

#### Автоматическая активация карты
1. **Система:** Периодическая задача (BullMQ) находит карты со статусом `planned`, у которых `startDateTime` уже наступило.
2. **Система:** Меняет их статус на `active`. Дополнительных проверок не требуется, так как валидация на этапе создания не позволяет создать "пустую" карту.

#### Завершение карты (и откат)

Это ключевой процесс, управляемый администратором, который запускает каскад системных обновлений.

**Процесс завершения:**
1. Администратор открывает активную карту, нажимает "Завершить карту".
2. В интерфейсе он **обязательно** выбирает **Победителя** (семью/команду) и **MVP** (игрока).
3. **Опционально** загружает JSON-файл со статистикой матча.
   - **Идентификация игрока в JSON:** `firstName` + `lastName` (которая является `displayLastName` для игроков в семьях).
4. **Опционально** вводит положительные очки рейтинга для Семей-участников.
5. **Система (после подтверждения):**
   - **Валидация:** Проверяет, что победитель и MVP выбраны.
   - **Обновление карты:** Меняет статус на `completed`, сохраняет `winner` и `mvp`.
   - **Рейтинг семей:** Если введен, вызывает `RatingService` для начисления очков.
   - **Статистика и рейтинг игроков:** Если загружен JSON:
     - Вызывает `StatisticsService` для парсинга и обновления статистики игроков.
     - Вызывает `RatingService` для начисления рейтинга игрокам (1 kill = 1 очко).
   - **Достижения:** Вызывает `AchievementService` для создания записей о наградах (MVP и др.).

**Процесс отката (Rollback):**
1. Администратор на странице завершенной карты нажимает "Открыть карту заново".
2. **Система:** Запускает парный процесс `rollbackMapCompletion`.
   - **Откат рейтингов:** Вызывает `RatingService` для отмены начислений за эту карту.
   - **Откат статистики:** Вызывает `StatisticsService` для вычитания статистики, добавленной за эту карту.
   - **Откат достижений:** Вызывает `AchievementService` для удаления достижений, связанных с этой картой.
   - **Сброс карты:** Очищает поля `winner`, `mvp`, `ratingChanges` и возвращает статус в `active`.

### 2.3 Система рейтинга

#### Рейтинг игроков
- **Принцип**: 1 убийство = 1 единица рейтинга
- **Процесс**:
  1. При завершении карты система подсчитывает kills для каждого игрока
  2. Автоматически начисляется рейтинг равный количеству убийств
  3. Обновляется поле rating в модели Player
  4. Создается запись в PlayerRatingHistory

#### Рейтинг семей
- **Принцип**: Ручное начисление администратором
- **Процесс**:
  1. При завершении карты администратор устанавливает изменения рейтинга для семей
  2. Система валидирует изменения (только положительные значения)
  3. Обновляется поле rating в модели Family
  4. Создается запись в FamilyRatingHistory

### 2.4 Система призов

#### Распределение призов
- **Принцип**: Равное деление между игроками команды/семьи
- **Процесс**:
  1. Администратор устанавливает призы для участников турнира
  2. Система распределяет призы поровну между игроками каждой семьи/команды
  3. Создаются записи PrizeAllocation для каждого игрока
  4. Обновляется totalEarnings в PlayerRatingHistory.overallStats

#### Типы валют
- **MajesticCoins**: Внутренняя валюта системы
- **GTADollars**: Игровая валюта
- **RealValue**: Реальные денежные призы

## 3. Бизнес-правила и ограничения

### 3.1 Правила участия

#### Игроки
- Игрок может состоять только в одной активной семье
- Игрок может участвовать в нескольких турнирах
- Игрок может быть в разных командах в разных турнирах

#### Семьи
- Семья может участвовать в нескольких турнирах одновременно

#### Команды
- Команда существует только в рамках одного турнира
- Команда имеет временный состав без истории изменений
- Игрок может быть в разных командах в разных турнирах

### 3.2 Правила турниров и карт

#### Турниры
- Турнир может содержать произвольное количество карт
- Турнир не может быть завершен без хотя бы одной завершенной карты
- Турнир может иметь только одного победителя (семья или команда)
- Статус турнира автоматически меняется на active при наступлении даты начала

#### Карты
- Карта должна быть привязана к турниру
- Карта не может быть завершена без выбранного MVP и Победителя. Загрузка статистики и начисление рейтинга семьям являются опциональными.
- Карта может иметь только одного победителя (семья или команда)
- Статус карты автоматически меняется на active при наступлении времени начала

### 3.3 Правила автоматического управления статусами

#### Автоматические изменения статусов
- Статус турнира меняется с planned на active автоматически при наступлении даты начала
- Статус карты меняется с planned на active автоматически при наступлении времени начала
- Статус completed устанавливается только вручную администратором
- При изменении даты/времени статус может быть автоматически скорректирован

#### Правила изменения расписания
- При переносе турнира/карты на более позднюю дату статус не меняется с active на planned
- При переносе турнира/карты на более раннюю дату статус может измениться с planned на active
- Завершенные турниры/карты (статус completed) не меняют статус при изменении расписания

### 3.4 Правила статистики

#### Игровая статистика
- Минимальный набор статистики: kills, deaths, damageDealt
- Детальная статистика включает: shotsFired, hits, headshots, weaponStats
- Виртуальные поля для расчетов: kdRatio, accuracy, headshotRate
- Статистика агрегируется на нескольких уровнях: карта, турнир, месяц, год

#### Месячная и годовая статистика
- Месячная статистика обновляется инкрементально при каждом участии
- Годовая статистика кэшируется в currentYearStats и обновляется инкрементально
- Завершенные годы "замораживаются" в yearlyArchive
- Доступна история по месяцам и годам через виртуальные поля

### 3.5 Система статистики и достижений

#### Статистика игроков
- **Общая статистика**:
  - Базовые метрики: kills, deaths, damage, maps played, wins
  - Рейтинг: текущий рейтинг, история изменений, пиковый рейтинг
  - Агрегированные метрики: K/D ratio, win rate, damage per map
  - Достижения: количество MVP, топ-3 результаты, награды

- **Статистика по оружию**:
  - Отслеживание по каждому оружию: kills, damage, shots fired, hits, headshots
  - Расчетные метрики: accuracy, headshot rate, damage per shot
  - Временные срезы: за все время, по месяцам, по годам
  - Любимое оружие и наиболее эффективное оружие

- **Временная статистика**:
  - Месячная статистика: kills, deaths, damage, maps played по месяцам
  - Годовая статистика: агрегированная статистика за текущий год
  - Архив годовой статистики: "замороженные" данные за прошлые годы
  - Тренды: изменение ключевых метрик во времени

- **Статистика участия в семьях**:
  - История членства: даты вступления и ухода из семей
  - Статистика выступлений за каждую семью: maps played, wins, K/D
  - Достижения в составе семей: командные награды, личные награды
  - Наиболее успешная семья для игрока

#### Статистика семей
- **Общая статистика**:
  - Базовые метрики: maps played, wins, win rate
  - Рейтинг: текущий рейтинг, история изменений, пиковый рейтинг
  - Турнирная статистика: участия, победы, призовые места
  - Коллективные достижения: MVP турниров, серии побед

- **Временная статистика**:
  - Месячная активность: количество карт и турниров по месяцам
  - Годовая статистика: агрегированная статистика за текущий год
  - Архив годовой статистики: данные за прошлые годы
  - Тренды: изменение активности и результативности во времени

- **Статистика участников**:
  - История членства: все игроки, когда-либо состоявшие в семье
  - Текущий состав: активные игроки семьи
  - Наиболее результативные игроки: по kills, damage, K/D
  - MVP семьи: игроки с наибольшим количеством наград MVP

#### Система достижений
- **Индивидуальные достижения**:
  - **Карточные**: MVP карты, лучший стрелок, лучший K/D, наибольший урон
  - **Турнирные**: MVP турнира, лучший стрелок турнира, наибольший вклад
  - **Временные**: лучший игрок месяца, прогресс года, серии побед
  - **Оружейные**: мастер снайпера, эксперт штурмовой винтовки, точность стрельбы

- **Командные достижения**:
  - **Победы**: победитель карты, победитель турнира, серия побед
  - **Стабильность**: высокий винрейт, длительные серии без поражений
  - **Коллективные**: лучшая командная игра, синергия состава
  - **Прогресс**: улучшение результатов, рост рейтинга

#### Рейтинговые таблицы
- **Топы игроков**:
  - По рейтингу: общий рейтинг игроков
  - По урону: наибольший средний урон за карту
  - По убийствам: наибольшее количество убийств
  - По картам: наибольшее количество сыгранных карт
  - Временные срезы: за все время, за месяц, за год

- **Топы семей**:
  - По рейтингу: общий рейтинг семей
  - По победам: наибольшее количество побед
  - По картам: наибольшее количество сыгранных карт
  - По винрейту: наилучшее соотношение побед к играм
  - Временные срезы: за все время, за месяц, за год

- **Отображение на главной странице**:
  - Топ-10 семей по рейтингу, сыгранным картам и победам
  - Топ-20 игроков по рейтингу, урону, убийствам и сыгранным картам
  - Переключение между временными срезами: все время, месяц, год
  - Автоматическое обновление после завершения карты или турнира

## 4. Доменные сервисы

### 4.1 TournamentService

**Назначение:** Управление жизненным циклом турниров, включая создание, активацию и завершение.

**Ключевые методы:**
```javascript
class TournamentService {
  constructor(tournamentRepo, familyRepo, playerRepo) { /* ... */ }
  async createTournament(data) { /* ... */ }
  async activateTournament(id) { /* ... */ }
  async completeTournament(id, winnerId, winnerType) { /* ... */ }
  async getParticipantsFromMaps(tournamentId) { /* ... */ }
}
```

**Функциональность:**
- **createTournament** - Создает новый турнир с указанными параметрами, валидирует данные, добавляет участников и публикует событие о создании.
- **activateTournament** - Активирует турнир, проверяя его текущий статус и наличие минимального количества участников.
- **completeTournament** - Завершает турнир, определяет победителя, распределяет призы и обновляет статистику участников.
- **getParticipantsFromMaps** - Агрегирует уникальных участников из всех карт турнира для формирования полного списка участников.

### 4.2 MapService

**Назначение:** Управление жизненным циклом карт, включая создание, активацию, загрузку статистики и завершение.

**Ключевые методы:**
```javascript
class MapService {
  constructor(mapRepo, tournamentRepo, playerRepo, ratingService) { /* ... */ }
  async createMap(data) { /* ... */ }
  async activateMap(id) { /* ... */ }
  async uploadStatistics(id, statistics) { /* ... */ }
  async completeMap(id, winnerId, winnerType, ratingChanges) { /* ... */ }
}
```

**Функциональность:**
- **createMap** - Создает новую карту в рамках активного турнира, проверяет валидность данных и добавляет участников.
- **activateMap** - Меняет статус карты на "active", проверяя наличие необходимых участников.
- **uploadStatistics** - Загружает и валидирует игровую статистику, сопоставляет данные с игроками.
- **completeMap** - Завершает карту, определяет победителя, обновляет рейтинги и статистику, создает записи участия.

### 4.3 RatingService

**Назначение:** Управление рейтингами игроков и семей, включая начисление и отмену изменений.

**Ключевые методы:**
```javascript
class RatingService {
  constructor(playerRepo, familyRepo, historyRepo) { /* ... */ }
  async updatePlayerRatings(mapId, statistics) { /* ... */ }
  async updateFamilyRatings(mapId, ratingChanges) { /* ... */ }
  async rollbackMapRatings(mapId) { /* ... */ }
}
```

**Функциональность:**
- **updatePlayerRatings** - Начисляет рейтинг игрокам на основе их убийств (1 kill = 1 рейтинг), обновляет профиль и создает запись в истории.
- **updateFamilyRatings** - Применяет изменения рейтинга к семьям, заданные администратором, обновляет профили и создает записи в истории.
- **rollbackMapRatings** - Отменяет все изменения рейтинга, связанные с конкретной картой, для игроков и семей.

### 4.4 ParticipationService

**Назначение:** Управление записями об участии игроков и семей в турнирах и картах.

**Ключевые методы:**
```javascript
class ParticipationService {
  constructor(playerParticipationRepo, familyParticipationRepo) { /* ... */ }
  async addMapParticipation(playerId, mapId, statistics) { /* ... */ }
  async addFamilyMapParticipation(familyId, mapId, isWinner) { /* ... */ }
  async rollbackMapParticipations(mapId) { /* ... */ }
}
```

**Функциональность:**
- **addMapParticipation** - Создает или обновляет запись об участии игрока в карте, обновляет месячную и годовую статистику.
- **addFamilyMapParticipation** - Создает или обновляет запись об участии семьи в карте, обновляет статистику.
- **rollbackMapParticipations** - Удаляет все записи участия, связанные с картой, и пересчитывает агрегированную статистику.

### 4.5 PrizeService

**Назначение:** Управление призовым фондом и распределением призов между участниками.

**Ключевые методы:**
```javascript
class PrizeService {
  constructor(playerRepo, tournamentRepo) { /* ... */ }
  async allocatePrizes(tournamentId, allocations) { /* ... */ }
  async rollbackPrizes(tournamentId) { /* ... */ }
}
```

**Функциональность:**
- **allocatePrizes** - Распределяет призы между игроками семей/команд, равномерно деля сумму между всеми участниками.
- **rollbackPrizes** - Отменяет все призовые начисления, связанные с конкретным турниром, и обновляет профили игроков.

### 4.6 SchedulerService

**Назначение:** Автоматическое управление статусами турниров и карт на основе их запланированного времени.

**Ключевые методы:**
```javascript
class SchedulerService {
  constructor(tournamentRepo, mapRepo, eventBus) { /* ... */ }
  async checkAndUpdateStatuses() { /* ... */ }
  async updateTournamentStatuses(now) { /* ... */ }
  async updateMapStatuses(now) { /* ... */ }
  hasMinimumParticipants(entity) { /* ... */ }
  async createStatusHistoryRecord(data) { /* ... */ }
}
```

**Функциональность:**
- **checkAndUpdateStatuses** - Запускает проверку и обновление статусов для турниров и карт.
- **updateTournamentStatuses** - Находит запланированные турниры с датой начала в прошлом и активирует их.
- **updateMapStatuses** - Находит запланированные карты с временем начала в прошлом и активирует их.
- **hasMinimumParticipants** - Проверяет наличие минимального количества участников для активации.
- **createStatusHistoryRecord** - Создает запись в журнале изменений статусов для аудита.

### 4.7 StatusHistoryService

**Назначение:** Управление историей изменений статусов для турниров и карт.

**Ключевые методы:**
```javascript
class StatusHistoryService {
  constructor(statusHistoryRepo) { /* ... */ }
  async createRecord(data) { /* ... */ }
  async getHistoryForEntity(entityType, entityId) { /* ... */ }
  async getRecentAutomaticChanges(limit = 50) { /* ... */ }
}
```

**Функциональность:**
- **createRecord** - Создает новую запись в истории изменений статуса с указанием типа сущности, старого и нового статуса.
- **getHistoryForEntity** - Получает полную историю изменений статусов для конкретной сущности.
- **getRecentAutomaticChanges** - Возвращает последние автоматические изменения статусов для отображения в интерфейсе администратора.

## 5. Интеграция с Redis

### 5.1 Кэширование доменных объектов

```javascript
// src/lib/repos/tournament-repo.js
export class TournamentRepository {
  constructor(cache) {
    this.cache = cache;
  }
  
  async findById(id) {
    const cacheKey = `tournament:${id}`;
    
    // Попытка получить из кэша
    const cached = await this.cache.get(cacheKey);
    if (cached) return cached;
    
    // Получение из БД
    const tournament = await Tournament.findById(id)
      .populate('participantFamilies.family')
      .lean();
    
    if (tournament) {
      // Сохранение в кэш с тегами
      await this.cache.set(cacheKey, tournament, {
        ttl: 300, // 5 минут
        tags: ['tournament', `tournament:${id}`]
      });
    }
    
    return tournament;
  }
  
  async update(id, data) {
    // Обновление в БД
    const tournament = await Tournament.findByIdAndUpdate(id, data, { new: true });
    
    // Инвалидация кэша
    await this.cache.invalidateByTag(`tournament:${id}`);
    
    return tournament;
  }
}
```

### 5.2 Публикация доменных событий

```javascript
// src/lib/domain/tournament-service.js
export class TournamentService {
  constructor(tournamentRepo, familyRepo, playerRepo, pubSub) {
    this.tournamentRepo = tournamentRepo;
    this.familyRepo = familyRepo;
    this.playerRepo = playerRepo;
    this.pubSub = pubSub;
  }
  
  async completeTournament(id, winnerId, winnerType) {
    // ... существующая логика
    
    // Публикация события
    await this.pubSub.publish('tournament:completed', {
      id: tournament._id.toString(),
      name: tournament.name,
      winner: {
        id: winnerId,
        type: winnerType,
        name: winnerName
      }
    });
    
    // Инвалидация связанных кэшей
    await this.cache.invalidateByTag(`tournament:${id}`);
    await this.cache.invalidateByTag('tournaments');
    
    return tournament;
  }
}
```

### 5.3 Обработка доменных событий

```javascript
// src/lib/event-handlers/tournament-events.js
export function setupTournamentEventHandlers(pubSub, cache, notificationService) {
  // Подписка на события завершения турнира
  pubSub.subscribe('tournament:completed', async (data) => {
    // Инвалидация кэша
    await cache.invalidateByTag(`tournament:${data.id}`);
    await cache.invalidateByTag('tournaments');
    
    // Отправка уведомлений
    await notificationService.sendNotification({
      type: 'TOURNAMENT_COMPLETED',
      title: `Турнир "${data.name}" завершен`,
      message: `Победитель: ${data.winner.name}`,
      data: {
        tournamentId: data.id,
        winnerId: data.winner.id,
        winnerType: data.winner.type
      }
    });
  });
}
```

### 5.4 Расширение репозиториев для автоматического управления статусами

```javascript
// src/lib/repos/tournament-repo.js
export class TournamentRepository {
  // ... существующие методы
  
  async findPlannedWithStartDateBefore(date) {
    const tournaments = await Tournament.find({
      status: 'planned',
      startDate: { $lte: date }
    }).lean();
    
    return tournaments;
  }
  
  async updateStatus(id, status) {
    const tournament = await Tournament.findByIdAndUpdate(
      id,
      { status },
      { new: true }
    );
    
    // Инвалидация кэша
    await this.cache.invalidateByTag(`tournament:${id}`);
    
    return tournament;
  }
}

// src/lib/repos/map-repo.js
export class MapRepository {
  // ... существующие методы
  
  async findPlannedWithStartTimeBefore(date) {
    const maps = await Map.find({
      status: 'planned',
      startDateTime: { $lte: date }
    }).lean();
    
    return maps;
  }
  
  async updateStatus(id, status) {
    const map = await Map.findByIdAndUpdate(
      id,
      { status },
      { new: true }
    );
    
    // Инвалидация кэша
    await this.cache.invalidateByTag(`map:${id}`);
    
    return map;
  }
}

### 5.5 Интеграция планировщика с BullMQ

**Назначение:** Настройка и инициализация очередей BullMQ для автоматического управления статусами.

**Ключевые компоненты:**

1. **Очереди для обработки статусов:**
   - `status:tournaments` - очередь для проверки и обновления статусов турниров
   - `status:maps` - очередь для проверки и обновления статусов карт

2. **Повторяющиеся задачи:**
   ```javascript
   // Пример настройки повторяющейся задачи
   tournamentStatusQueue.add(
     'check-tournament-statuses',
     {},
     {
       jobId: 'recurring-tournament-status-check',
       repeat: {
         every: 30000 // 30 секунд
       }
     }
   );
   ```

3. **Обработчики задач:**
   - Обрабатывают задачи из очередей
   - Вызывают соответствующие методы доменных сервисов
   - Обрабатывают и логируют ошибки

4. **Предотвращение дублирования:**
   - Использование уникальных jobId для повторяющихся задач
   - Блокировки Redis для предотвращения одновременного выполнения

5. **Мониторинг и логирование:**
   - Обработка событий `completed` и `failed`
   - Структурированное логирование с контекстом задачи

### 5.6 Обработка событий изменения статуса

**Назначение:** Обработка событий, возникающих при изменении статусов турниров и карт.

**Ключевые операции:**

1. **Подписка на события:**
   - `tournament.status.changed` - событие изменения статуса турнира
   - `map.status.changed` - событие изменения статуса карты

2. **Действия при изменении статуса:**
   - Инвалидация соответствующих записей в кэше
   - Логирование события с контекстом
   - Обновление связанных сущностей (при необходимости)

3. **Пример подписки на события:**
   ```javascript
   eventBus.subscribe('tournament.status.changed', async (data) => {
     // Инвалидация кэша
     await cache.invalidateByTag(`tournament:${data.id}`);
     // Логирование события
     logger.info(`Tournament status changed: ${data.oldStatus} -> ${data.newStatus}`);
   });
   ```

### 5.7 Запуск планировщика в приложении

**Назначение:** Интеграция планировщика задач в основное приложение Next.js.

**Ключевые компоненты:**

1. **Инициализация сервисов:**
   - Подключение к MongoDB и Redis
   - Создание репозиториев и доменных сервисов
   - Настройка обработчиков событий

2. **Настройка BullMQ:**
   - Инициализация очередей и обработчиков
   - Настройка повторяющихся задач

3. **Мониторинг с Bull Board:**
   - Интеграция с Express для доступа к панели мониторинга
   - Защита доступа с помощью базовой аутентификации
   ```javascript
   // Пример настройки Bull Board
   const serverAdapter = new ExpressAdapter();
   serverAdapter.setBasePath('/admin/queues');
   
   createBullBoard({
     queues: [
       new BullMQAdapter(tournamentStatusQueue),
       new BullMQAdapter(mapStatusQueue)
     ],
     serverAdapter
   });
   ```

4. **Корректное завершение работы:**
   - Обработка сигналов SIGTERM и SIGINT
   - Закрытие подключений к BullMQ, Redis и MongoDB
   - Логирование процесса завершения работы 

### 4.3 Модульная архитектура компонентов

**Принципы организации компонентов:**

1. **Разделение ответственности:**
   - **Контейнерные компоненты** - управляют состоянием и бизнес-логикой
   - **Презентационные компоненты** - отвечают только за отображение UI
   - **Хуки** - инкапсулируют логику работы с данными и состоянием

2. **Структура модулей:**
   - **Компоненты** - изолированные презентационные части интерфейса
   - **Хуки** - переиспользуемая логика для работы с данными
   - **Утилиты** - вспомогательные функции для обработки данных

3. **Организация файлов:**
   - Группировка по функциональности и доменной области
   - Компоненты верхнего уровня в корне папки
   - Вложенные компоненты в подпапке components
   - Связанные хуки в подпапке hooks
   - Утилиты в подпапке utils

4. **Правила именования:**
   - Контейнерные компоненты с суффиксом Container
   - Презентационные компоненты с суффиксом View
   - Хуки с префиксом use
   - Утилиты с суффиксом Helpers или Utils

5. **Передача данных:**
   - Контейнеры получают данные через API или хуки
   - Презентационные компоненты получают данные только через props
   - Избегание глубокой передачи props через использование композиции

**Пример структуры для формы создания/редактирования:**
```
├── компоненты/
│   └── админ/
│       └── ФормаКарты/
│           ├── компоненты/     # Презентационные компоненты
│           │   ├── БазовыеПоля.jsx
│           │   ├── БлокУчастников.jsx
│           │   └── БлокСтатистики.jsx
│           ├── хуки/           # Хуки с логикой
│           │   ├── использованиеФормы.js
│           │   └── использованиеУчастников.js
│           ├── утилиты/        # Утилиты
│           │   └── вспомогательныеФункции.js
│           ├── Контейнер.jsx   # Контейнер с состоянием
│           └── Представление.jsx # Презентационный компонент
``` 