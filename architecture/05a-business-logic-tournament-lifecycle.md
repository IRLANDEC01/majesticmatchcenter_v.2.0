# Жизненный цикл Турнира: Бизнес-логика

Этот документ описывает полный жизненный цикл сущности "Турнир", от его создания до архивации. Он служит источником правды для реализации соответствующей бизнес-логики в сервисах и UI.

## Статусы Турнира

Турнир может находиться в одном из следующих состояний:
- `planned`: Создан, но регистрация закрыта.
- `registration_open`: Открыта регистрация участников.
- `registration_closed`: Регистрация завершена, состав участников финальный.
- `active`: Турнир идет, карты генерируются и проводятся.
- `completed`: Турнир завершен, победители определены, призы начислены.
- `archived`: Турнир завершен и перенесен в архив.

---

## Этапы Жизненного Цикла

### 1. Создание Турнира (Creation)

- **Триггер:** Администратор нажимает "Создать турнир" в админ-панели.
- **Действия в UI:** Заполняет форму: выбирает `TournamentTemplate`, указывает название, даты, призовой фонд.
- **Бизнес-логика (`tournament-service`):**
  - Создается новый документ `Tournament` со статусом **`planned`**.
  - Карты (`Map`) на этом этапе **не создаются**. В `Tournament` хранится только ссылка на шаблон.
  - Список участников (`participants`) пуст.

### 2. Регистрация на Турнир (Registration)

- **Триггер:** Администратор меняет статус турнира с `planned` на `registration_open`.
- **Действия в UI:** В админ-панели появляется интерфейс для добавления семей в список участников.
- **Бизнес-логика:**
  - Статус турнира меняется на `registration_open`.
  - Администратор наполняет массив `participants` в документе `Tournament`.
  - После финализации состава, администратор меняет статус на `registration_closed`.

### 3. Начало Турнира (Active)

- **Триггер:** Администратор вручную нажимает "Начать турнир" (этот вариант более гибкий, чем автоматический старт по дате).
- **Бизнес-логика (`tournament-service`):**
  - Статус турнира меняется на **`active`**.
  - **Ключевое действие:** Автоматически генерируются все необходимые документы `Map` на основе `MapTemplate`, указанных в шаблоне.
  - Каждая созданная карта получает статус `planned` и ссылку на `tournamentId`.
  - Массив `maps` в документе `Tournament` заполняется ID свежесозданных карт.

### 4. Проведение Турнира (In Progress)

- **Триггер:** Администратор последовательно завершает карты турнира через UI.
- **Бизнес-логика:**
  - Используется существующая логика `map-service.completeMap`.
  - Статус отдельных карт меняется с `planned` на `completed`.
  - Статус самого турнира остается `active`.

### 5. Завершение Турнира (Completion)

- **Триггер:** Администратор нажимает "Завершить турнир" (кнопка активна, когда все карты `completed`).
- **Бизнес-логика (`tournament-service.completeTournament`):**
  - Статус турнира меняется на **`completed`**.
  - **Определение победителя:** Логика определяет победителя по числу выигранных карт.
  - **Начисление призов (Future):** Запускается будущая логика для распределения `prizePool` и создания `Earning` документов.
  - **Обновление статистики (Future):** Асинхронно обновляются `PlayerStats` и `FamilyStats` (например, `tournamentsWon: +1`).

### 6. Архивация (Archived)

- **Триггер:** Администратор нажимает "Архивировать".
- **Бизнес-логика:**
  - Устанавливается поле `archivedAt`. Документ не удаляется, а скрывается из основных списков. 