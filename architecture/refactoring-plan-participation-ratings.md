# Комплексный План Рефакторинга Системы Участия и Рейтингов

**Дата утверждения:** 25.07.2024
**Статус:** Утверждено

## 1. Главная цель

Создать симметричную, логичную и производительную систему учета истории и рейтингов для **Игроков** и **Семей**. Основной принцип: **"Одно участие в карте — одна целостная запись"**. Это устранит "архитектурный долг", повысит производительность запросов и упростит дальнейшую разработку.

## 2. Архитектурная концепция

Для Игроков и Семей будет внедрена единая 3-компонентная система:

1.  **Основная Модель (`Player.js`, `Family.js`):**
    *   **Роль:** Хранит только **текущий актуальный рейтинг**. Является единым источником правды для этого значения.
    *   **Пример:** `Player.rating`, `Family.rating`.

2.  **Модель Участия в Карте (`PlayerMapParticipation.js`, `FamilyMapParticipation.js`):**
    *   **Роль:** Хранит **полный контекст** участия в одной конкретной карте. Отвечает на вопросы "Как сыграл?", "Что получил?".
    *   **Содержит:** Статистику (kills/deaths), результат (isWinner) и полный контекст изменения рейтинга (`previousRating`, `newRating`, `ratingChange`).
    *   **Заменяет:** Полностью вытесняет избыточные схемы `PlayerRatingHistory` и `FamilyRatingHistory`.

3.  **Модель Участия в Турнире (`PlayerTournamentParticipation.js`, `FamilyTournamentParticipation.js`):**
    *   **Роль:** Хранит **агрегированную (суммарную) статистику** за весь турнир. Используется для быстрого ответа на вопрос "Как выступил на турнире в целом?".

4.  **Модель Статистики (`PlayerStats.js`, `FamilyStats.js`):**
    *   **Роль:** Денормализованный **кэш** для мгновенного построения лидербордов (топ за месяц/год/всё время).
    *   **Обновляется:** После каждой карты на основе данных из моделей Участия.

## 3. План Действий по Кодовой Базе

### 3.1. Изменения в Схемах (Schemas)

*   **УДАЛИТЬ:**
    1.  `src/models/player/PlayerRatingHistory.js`
    2.  `src/models/family/FamilyRatingHistory.js`
    3.  `src/lib/repos/ratings/player-rating-history-repo.js`
    4.  `src/lib/repos/ratings/family-rating-history-repo.js`

*   **ИЗМЕНИТЬ:**
    1.  **`src/models/player/PlayerMapParticipation.js`**: Добавить поля `ratingChange: Number`, `previousRating: Number`, `newRating: Number`.

*   **СОЗДАТЬ:**
    1.  **`src/models/family/FamilyMapParticipation.js`**: Новая схема для записи истории участий семей в картах с полями `familyId`, `mapId`, `isWinner`, `ratingChange`, `previousRating`, `newRating` и др.
    2.  **`src/models/family/FamilyTournamentParticipation.js`**: Новая схема для записи агрегированной статистики семей в турнирах с полями `familyId`, `tournamentId`, `isWinner`, `mapsPlayed` и др.

### 3.2. Изменения в Сервисной Логике (Services)

*   **`rating-service.js`**:
    *   Перестает работать с репозиториями `...RatingHistoryRepo`.
    *   `updatePlayerRatings`: Обновляет запись в `PlayerMapParticipation`, добавляя в нее рейтинговый контекст.
    *   `updateFamilyRatings`: Создает новую запись в `FamilyMapParticipation` с полным контекстом.

*   **`statistics-service.js`**:
    *   В дополнение к обновлению `PlayerStats` и `FamilyStats`, будет отвечать за создание и обновление агрегированных записей в `...TournamentParticipation`.

### 3.3. Изменения в Тестировании

*   **Очистка:** Из `beforeEach` во всех тестах убрать очистку коллекций `...RatingHistory`. Добавить очистку `...MapParticipation` и `...TournamentParticipation`.
*   **Проверки (Asserts):** Тесты станут проще и надежнее. Вместо проверки двух разных коллекций, тест будет делать запрос к одной `...MapParticipation` и проверять в одной записи сразу всю статистику и контекст рейтинга.

## 4. Обновление Документации

*   **`architecture/05-business-logic.md`**: Будет полностью переписан раздел о рейтингах и истории участий, чтобы отразить новую 3-компонентную архитектуру.
*   **`architecture/10-testing-strategy.md`**: Будет добавлен новый анти-паттерн: "Попытка агрегировать данные из несвязанных коллекций вместо создания целостной записи об участии", чтобы закрепить полученный опыт. 