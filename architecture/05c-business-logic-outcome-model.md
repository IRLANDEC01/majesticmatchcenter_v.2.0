# Паттерн "Модель, управляемая результатом" (Outcome-Driven Model)

Этот документ описывает унифицированную архитектуру для обработки и хранения результатов участия в турнирах. Цель — отказаться от жестко заданных типов турниров (`scoringType`) в пользу гибкой модели, способной описать любой исход — от лидерборда до олимпийской сетки.

## 1. Ключевые концепции: `tier` и `rank`

В основе модели лежат два поля, которые хранятся в записи об участии (`FamilyTournamentParticipation`):

*   **`rank` (ранг):** Числовое, порядковое место участника (1, 2, 15). Это опциональное поле, которое имеет смысл в турнирах с явной сортировкой (лидерборд).
*   **`tier` (категория/уровень):** Текстовая константа, описывающая **смысл** результата. Это обязательное поле, которое является главным классификатором.

**Примеры:**
- Победитель турнира по очкам: `{ rank: 1, tier: 'winner' }`.
- Участник, проигравший в полуфинале: `{ rank: 3, tier: 'semi-finalist' }`.
- Победитель, выбранный вручную (без очков): `{ tier: 'winner' }`.
- Обычный участник: `{ tier: 'participant' }`.

## 2. Предлагаемые константы `RESULT_TIERS`

Этот список будет определен в `src/lib/constants.js` и может быть расширен в будущем.

| Константа        | Значение          | Описание                                                              |
| ---------------- | ----------------- | --------------------------------------------------------------------- |
| `WINNER`         | `'winner'`        | Бесспорный победитель.                                                |
| `RUNNER_UP`      | `'runner-up'`     | Второе место, финалист.                                               |
| `SEMI_FINALIST`  | `'semi-finalist'` | Участник, выбывший в полуфинале (3-4 места).                         |
| `QUARTER_FINALIST`| `'quarter-finalist'`| Участник, выбывший в четвертьфинале (5-8 места).                    |
| `TOP_TIER`       | `'top-tier'`      | Общая категория для участников из топа (например, топ-16).            |
| `PARTICIPANT`    | `'participant'`   | Стандартный результат для всех остальных.                             |
| `DISQUALIFIED`   | `'disqualified'`  | Участник, который был дисквалифицирован.                              |

## 3. Обновленные схемы

### `Tournament.js`
- Поле `scoringType` **удаляется**.
- Поле `prizePool` модифицируется.

**Новая структура `prizePool`:**
Правила в `prizePool` теперь нацелены не на ранг, а на комбинацию `tier` и `rank`.

```javascript
// Пример правила в prizePool
{
  // На что нацелено правило. Должен быть хотя бы один из параметров.
  target: {
    tier: { type: String, enum: RESULT_TIERS_VALUES }, // e.g., 'winner'
    rank: { 
      from: { type: Number }, // e.g., 1
      to: { type: Number }   // e.g., 3
    }
  },
  // Какую награду выдать.
  reward: {
    amount: { type: Number },
    currency: { type: String, enum: CURRENCY_VALUES }
  },
  // ИЛИ общий котел для разделения
  pot: {
    amount: { type: Number },
    currency: { type: String, enum: CURRENCY_VALUES }
  }
}
```

### `FamilyTournamentParticipation.js`
- Поле `finalPlace` **удаляется**.
- Добавляется новый объект `result`.

```javascript
// Новое поле в FamilyTournamentParticipation
result: {
  tier: { type: String, enum: RESULT_TIERS_VALUES, required: true, default: 'participant' },
  rank: { type: Number, min: 1, sparse: true }, // Индекс, если поле существует
  points: { type: Number, sparse: true },
}
```

## 4. План реализации (Задачи)

1.  **Константы:** Добавить `RESULT_TIERS` в `src/lib/constants.js`.
2.  **Схемы:**
    - Изменить `FamilyTournamentParticipation.js`, заменив `finalPlace` на объект `result`.
    - Изменить `Tournament.js`, удалив `scoringType` и обновив схему `prizePool` до новой структуры с `target`.
3.  **Сервис `tournament-service.js`:**
    - Полностью переписать метод `completeTournament`.
    - Логика больше не зависит от типа турнира. Она должна:
        а. Получить итоговый список участников (`placements`).
        б. Для каждого участника определить его `tier` и `rank` (если применимо).
        в. Для каждого участника найти подходящее правило в `prizePool` по `target.tier` или `target.rank`.
        г. Рассчитать и выдать награды (`reward` или из `pot`).
        д. Атомарно обновить все записи `FamilyTournamentParticipation` с новым объектом `result` и `earnings`.
4.  **Тесты:**
    - Переписать `tournaments/[id]/complete/route.test.js` для тестирования новой универсальной логики.
    - Проверить и исправить все тесты, которые могли быть затронуты удалением `scoringType`.
5.  **Административная панель (Будущее):**
    - UI для завершения турнира должен предоставлять разные инструменты в зависимости от конфигурации `prizePool` (например, показать таблицу для ручного подтверждения или просто кнопку "выбрать победителя"). 